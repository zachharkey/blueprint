{"name":"Blueprint","tagline":"Reverse engineer server configuration","body":"---\r\nlayout: default\r\n---\r\n\r\nBlueprint\r\n=========\r\n\r\nBlueprint is a simple configuration management tool that reverse-engineers servers.  It figures out what you've done manually, stores it locally in a Git repository, generates code that's able to recreate your efforts, and helps you deploy those changes to production.\r\n\r\n<h2 id=\"toc\">Table of contents</h2>\r\n\r\n1.  [Philosophy](#philosophy)\r\n2.  [Installation](#installation)\r\n3.  [Reverse-engineering systems with blueprint-create](#create)\r\n4.  [Inspecting blueprints](#inspect)\r\n5.  [Ignoring particular resources](#ignore)\r\n6.  [Rules files and blueprint-rules](#rules)\r\n7.  [Diffing, splitting and pruning existing blueprints](#diff-split-prune)\r\n8.  [Rendering templates of configuration files](#templates)\r\n9. [Controlling service restart conditions](#services)\r\n10. [Generating POSIX shell scripts](#sh)\r\n11. [Sharing and distributing blueprints](#push-pull)\r\n12. [Generating Puppet modules and Chef cookbooks](#puppet-chef)\r\n13. [Integrating with AWS CloudFormation](#cloudformation)\r\n14. [Deploying your application with Blueprint](#deploy)\r\n15. [Local Git repository](#git)\r\n16. [Running your own Blueprint Server](#server)\r\n17. [Blueprint Server Protocols](#protocols)\r\n18. [Blueprint Server Endpoints](#endpoints)\r\n19. [Contributing to Blueprint](#contributing)\r\n20. [Alternatives to Blueprint](#alternatives)\r\n\r\n<h2 id=\"man\">Manuals</h2>\r\n\r\n* [`blueprint-list`(1)](http://devstructure.github.com/blueprint/blueprint-list.1.html): list all blueprints.\r\n* [`blueprint-create`(1)](http://devstructure.github.com/blueprint/blueprint-create.1.html): create a blueprint.\r\n* [`blueprint-rules`(1)](http://devstructure.github.com/blueprint/blueprint-rules.1.html): create a blueprint from a blueprint-rules file.\r\n* [`blueprint-show`(1)](http://devstructure.github.com/blueprint/blueprint-show.1.html): generate code from a blueprint.\r\n* [`blueprint-diff`(1)](http://devstructure.github.com/blueprint/blueprint-diff.1.html): save the difference between two blueprints.\r\n* [`blueprint-split`(1)](http://devstructure.github.com/blueprint/blueprint-split.1.html): split one blueprint into two others interactively.\r\n* [`blueprint-prune`(1)](http://devstructure.github.com/blueprint/blueprint-prune.1.html): select a subset of resources interactively.\r\n* [`blueprint-template`(1)](http://devstructure.github.com/blueprint/blueprint-template.1.html): render mustache.sh templates locally.\r\n* [`blueprint-apply`(1)](http://devstructure.github.com/blueprint/blueprint-apply.1.html): run a blueprint's generated shell code.\r\n* [`blueprint-push`(1)](http://devstructure.github.com/blueprint/blueprint-push.1.html): push a blueprint to the Internet.\r\n* [`blueprint-pull`(1)](http://devstructure.github.com/blueprint/blueprint-pull.1.html): pull a blueprint from the Internet.\r\n* [`blueprint-destroy`(1)](http://devstructure.github.com/blueprint/blueprint-destroy.1.html): destroy a blueprint.\r\n* [`blueprint`(5)](http://devstructure.github.com/blueprint/blueprint.5.html): Blueprint JSON format.\r\n* [`blueprintignore`(5)](http://devstructure.github.com/blueprint/blueprintignore.5.html): ignore specific files when creating blueprints.\r\n* [`blueprint-rules`(5)](http://devstructure.github.com/blueprint/blueprint-rules.5.html): enumerate resources in blueprints.\r\n* [`blueprint.cfg`(5)](http://devstructure.github.com/blueprint/blueprint.cfg.5.html): centralized blueprint service configuration.\r\n* [`blueprint-template`(5)](http://devstructure.github.com/blueprint/blueprint-template.5.html): `mustache.sh` template language syntax.\r\n* [`blueprint-template`(7)](http://devstructure.github.com/blueprint/blueprint-template.7.html): built-in template data.\r\n* [`blueprint`(7)](http://devstructure.github.com/blueprint/blueprint.7.html): Blueprint Python library.\r\n\r\n### Plumbing\r\n\r\n* [`blueprint-git`(1)](http://devstructure.github.com/blueprint/blueprint-git.1.html): low-level access to blueprints.\r\n* [`blueprint-show-files`(1)](http://devstructure.github.com/blueprint/blueprint-show-files.1.html): show files in a blueprint.\r\n* [`blueprint-show-ignore`(1)](http://devstructure.github.com/blueprint/blueprint-show-ignore.1.html): show `blueprintignore`(5) rules from a blueprint.\r\n* [`blueprint-show-packages`(1)](http://devstructure.github.com/blueprint/blueprint-show-packages.1.html): show packages in a blueprint.\r\n* [`blueprint-show-services`(1)](http://devstructure.github.com/blueprint/blueprint-show-services.1.html): show services in a blueprint.\r\n* [`blueprint-show-sources`(1)](http://devstructure.github.com/blueprint/blueprint-show-sources.1.html): show source tarballs in a blueprint.\r\n\r\nAPIs\r\n----\r\n\r\n* [Blueprint Server Protocols](#protocols)\r\n* [Blueprint Server Endpoints](#endpoints)\r\n\r\n----\r\n\r\n<h1 id=\"philosophy\">Philosophy</h1>\r\n\r\nBlueprint was born out of frustration with development environments, deployment processes, and the complexity of configuration management systems.\r\n\r\nBlueprint insists development environments realistically model production and that starts with using Linux.  Blueprint only works on Debian- or Red Hat-based Linux systems.  We recommend VirtualBox, Vagrant, Rackspace Cloud, or AWS EC2 for development systems that use the same operating system (and version) as is used in production.\r\n\r\nOn top of the operating system, we recommend using the same web servers, databases, message queue brokers, and other software in development and production.  This brings development visibility to entire classes of bugs that only occur due to interactions between production components.\r\n\r\nWhen development and production share the same operating system and software stack, they also share the same interactive management tools, meaning developers and operators alike don't need to maintain two vocabularies.  Well-understood tools like `apt-get`/`dpkg`, `yum`/`rpm`, and the whole collection of Linux system tools are available everywhere.  Blueprint is unique relative to other configuration management in encouraging use of these tools.\r\n\r\nWhat's common to all configuration management tools is the desire to manage the whole stack: from the operating system packages and services through language-specific packages, all the way to your applications.  We need to span all of these across all our systems.  To pick on RubyGems arbitrarily: RubyGems is purposely ignorant of its relationship to the underlying system, favoring compatibility with Windows and a wide variety of UNIX-like operating systems.  Blueprint understands the macro-dependencies between RubyGems itself and the underlying system and is able to predictably reinstall a selection of gems on top of a properly configured operating system.\r\n\r\nWhen constructing this predictable order-of-operations used to reinstall files, packages, services, and source installations, Blueprint, along with other configuration management tools, takes great care in performing idempotent actions.  Thus Blueprint prefers to manage the entire contents of a file rather than a diff or a line to append.  Idempotency means you can apply a blueprint over and over again with confidence that nothing will change if nothing needs to change.\r\n\r\nBecause Blueprint can reverse-engineer systems, it is of particular use migrating legacy systems into configuration management.  It doesn't matter when you install Blueprint: changes made to the system even before Blueprint is installed will be taken into account.\r\n\r\n----\r\n\r\n<h1 id=\"installation\">Installation</h1>\r\n\r\nPrerequisites:\r\n\r\n* Debian- or RPM-based Linux\r\n* Python >= 2.6\r\n* Git >= 1.7 (not just for installation from source)\r\n\r\nFrom DevStructure's Debian archive\r\n----------------------------------\r\n\r\n\techo \"deb http://packages.devstructure.com $(lsb_release -sc) main\" | sudo tee /etc/apt/sources.list.d/devstructure.list\r\n\tsudo wget -O /etc/apt/trusted.gpg.d/devstructure.gpg http://packages.devstructure.com/keyring.gpg\r\n\tsudo apt-get update\r\n\tsudo apt-get -y install blueprint\r\n\r\nFrom PyPI\r\n---------\r\n\r\n\tpip install blueprint\r\n\r\nMake sure `pip` is using Python >= 2.6, otherwise the installation will succeed but Blueprint will not run.\r\n\r\nFrom source on Debian, Ubuntu, Fedora, CentOS 6, and RHEL 6\r\n-----------------------------------------------------------\r\n\r\n\tgit clone git://github.com/devstructure/blueprint.git\r\n\tcd blueprint\r\n\tgit submodule update --init\r\n\tmake && sudo make install\r\n\r\nFrom source on CentOS 5 and RHEL 5\r\n----------------------------------\r\n\r\n\trpm -Uvh http://download.fedora.redhat.com/pub/epel/5/i386/epel-release-5-4.noarch.rpm\r\n\tyum install python26\r\n\tgit clone git://github.com/devstructure/blueprint.git\r\n\tcd blueprint\r\n\tgit submodule update --init\r\n\tmake && sudo make install PYTHON=/usr/bin/python26\r\n\r\nThis installs Python 2.6 from EPEL side-by-side with Python 2.4 and so won't break Yum.\r\n\r\n----\r\n\r\n<h1 id=\"create\">Reverse-engineering systems with blueprint-create</h1>\r\n\r\nBy now you've hopefully created a development environment running the same operating system (and version) that you use in production and installed your production stack.  If this is your first time configuring production databases and web servers, don't be shy about copying-and-pasting from the guy at the next desk or a staging or production system (perhaps even multiple systems).\r\n\r\nOnce Blueprint itself is installed you can reverse-engineer your development system with a single command.\r\n\r\n<pre><code>blueprint create <em>name</em></code></pre>\r\n\r\nBlueprint will list packages managed by APT, Yum, RubyGems, Python's `easy_install` and `pip`, PHP's PEAR and PECL, and Node.js' NPM.  It will also determine which configuration files in `/etc` have been added or modified from their packaged versions and collect files in `/usr/local` that are part of any software packages installed from source (typically via GNU `make`(1)).  Finally, it will build a list of conditions under which System V init or Upstart services should be restarted, including package upgrades and configuration changes.\r\n\r\nAll of this information is encoded in a `blueprint`(5) JSON document and zero or more `tar`(5) archives and stored in a branch called _name_ in the local Git repository `~/.blueprints.git`.\r\n\r\nAny blueprint in the local Git repository may be applied to the system with `blueprint-apply`(1):\r\n\r\n<pre><code>blueprint apply <em>name</em></code></pre>\r\n\r\nExample\r\n-------\r\n\r\nSuppose you want to install a basic Ruby stack for running a Sinatra application called `example` proxied by Nginx on Debian-based Linux.  Install the prerequisite packages:\r\n\r\n\tsudo apt-get install build-essential nginx-light ruby ruby-dev rubygems\r\n\tsudo gem install sinatra unicorn\r\n\r\nConfigure Nginx in `/etc/nginx/sites-available/example`:\r\n\r\n\tserver {\r\n\t\tlisten 80 default;\r\n\t\tlocation /static { root /usr/local/share/rack/example/static; }\r\n\t\tlocation / { proxy_pass http://127.0.0.1:8080; }\r\n\t}\r\n\r\nEnable the Nginx configuration:\r\n\r\n\tln -s /etc/nginx/sites-{available,enabled}/example\r\n\r\nCreate the application itself.  `/usr/local/share/rack/example/app.rb`:\r\n\r\n\trequire 'sinatra'\r\n\tget '/hi' do\r\n\t  \"Hello, world!\\n\"\r\n\tend\r\n\r\n`/usr/local/share/rack/example/config.ru`:\r\n\r\n\trequire 'app'\r\n\trun Sinatra::Application\r\n\r\nConfigure Unicorn in `/etc/unicorn.conf.rb`:\r\n\r\n\tworker_processes 4\r\n\r\nConfigure Upstart to run the application:\r\n\r\n\tdescription \"Example\"\r\n\tstart on runlevel [2345]\r\n\tstop on runlevel [!2345]\r\n\trespawn\r\n\tchdir /usr/local/share/rack/example\r\n\texec unicorn -c /etc/unicorn.conf.rb\r\n\r\nNow create a blueprint and call it _example_.\r\n\r\n\tsudo blueprint create example\r\n\r\nWe'll pick this example up in the next chapter.\r\n\r\n----\r\n\r\n<h1 id=\"inspect\">Inspecting blueprints</h1>\r\n\r\nOnce a blueprint has been created and stored in the local Git repository, it's easy to inspect what's been included both in its raw JSON form and in more friendly formats.\r\n\r\nFirst, print the entire `blueprint`(5) JSON document:\r\n\r\n<pre><code>blueprint show <em>name</em> | less</code></pre>\r\n\r\nThe output of `blueprint-show`(1) can be a bit overwhelming, which is one of the reasons the following four commands were created.\r\n\r\n`blueprint-show-files`(1) lists the pathname of each file included in the blueprint on its own line.\r\n\r\n<pre><code><em>pathname</em></code></pre>\r\n\r\n`blueprint-show-packages`(1) lists the manager (\"`apt`\", \"`yum`\", \"`rubygems1.8`\", etc.), name, and version number for each package included in the blueprint on its own line.  If two versions of the same package are included (as is possibly with RubyGems and some other package managers), each will be printed on its own line.\r\n\r\n<pre><code><em>manager</em> <em>package</em> <em>version</em></code></pre>\r\n\r\n`blueprint-show-services`(1) lists the manager (\"`sysvinit`\" or \"`upstart`\") and name of each service included in the blueprint on its own line.\r\n\r\n<pre><code><em>manager</em> <em>service</em></code></pre>\r\n\r\n`blueprint-show-sources`(1) lists the source installations included in the blueprint.  The root directory (for example, \"`/usr/local`\") and tarball filename are printed to standard error and the contents of the tarball are printed to standard output via `tar`(1)'s `tv` options.\r\n\r\n<pre><code><em>dirname</em> <em>filename</em><br /><em>`tar tv` output</em></code></pre>\r\n\r\nExample\r\n-------\r\n\r\n`blueprint show-files example`\r\n\r\n\t/etc/apt/sources.list\r\n\t/etc/hosts\r\n\t/etc/init/example.conf\r\n\t/etc/mysql/debian.cnf\r\n\t/etc/nginx/sites-available/example\r\n\t/etc/nginx/sites-enabled/default\r\n\t/etc/nginx/sites-enabled/example\r\n\t/etc/unicorn.conf.rb\r\n\r\n`blueprint show-packages example`\r\n\r\n\tapt binutils 2.21.53.20110810-0ubuntu3\r\n\tapt blueprint 3.4.0-1py2.7\r\n\tapt build-essential 11.5ubuntu1\r\n\tapt ca-certificates 20110502+nmu1ubuntu5\r\n\tapt cpp 4:4.6.1-2ubuntu5\r\n\tapt cpp-4.6 4.6.1-9ubuntu3\r\n\tapt curl 7.21.6-3ubuntu3\r\n\tapt dpkg-dev 1.16.0.3ubuntu5\r\n\tapt fakeroot 1.17-1\r\n\tapt g++ 4:4.6.1-2ubuntu5\r\n\tapt g++-4.6 4.6.1-9ubuntu3\r\n\tapt gcc 4:4.6.1-2ubuntu5\r\n\tapt gcc-4.6 4.6.1-9ubuntu3\r\n\tapt git 1:1.7.5.4-1\r\n\tapt git-core 1:1.7.5.4-1\r\n\tapt git-man 1:1.7.5.4-1\r\n\tapt libalgorithm-diff-perl 1.19.02-2\r\n\tapt libalgorithm-diff-xs-perl 0.04-1build1\r\n\tapt libalgorithm-merge-perl 0.08-2\r\n\tapt libc-dev-bin 2.13-20ubuntu5\r\n\tapt libc6-dev 2.13-20ubuntu5\r\n\tapt libcurl3 7.21.6-3ubuntu3\r\n\tapt libcurl3-gnutls 7.21.6-3ubuntu3\r\n\tapt libdbd-mysql-perl 4.019-1\r\n\tapt libdbi-perl 1.616-1build1\r\n\tapt libdpkg-perl 1.16.0.3ubuntu5\r\n\tapt liberror-perl 0.17-1\r\n\tapt libgmp10 2:5.0.1+dfsg-7ubuntu2\r\n\tapt libgomp1 4.6.1-9ubuntu3\r\n\tapt libhtml-template-perl 2.10-1\r\n\tapt libmpc2 0.9-3\r\n\tapt libmpfr4 3.0.1-5\r\n\tapt libmysqlclient16 5.1.58-1ubuntu1\r\n\tapt libnet-daemon-perl 0.48-1\r\n\tapt libplrpc-perl 0.2020-2\r\n\tapt libquadmath0 4.6.1-9ubuntu3\r\n\tapt libreadline5 5.2-9ubuntu1\r\n\tapt librtmp0 2.3-2ubuntu1\r\n\tapt libruby1.8 1.8.7.352-2\r\n\tapt libstdc++6-4.6-dev 4.6.1-9ubuntu3\r\n\tapt libtimedate-perl 1.2000-1\r\n\tapt libwrap0 7.6.q-21\r\n\tapt linux-libc-dev 3.0.0-12.20\r\n\tapt manpages-dev 3.27-1ubuntu2\r\n\tapt mysql-client-5.1 5.1.58-1ubuntu1\r\n\tapt mysql-client-core-5.1 5.1.58-1ubuntu1\r\n\tapt mysql-common 5.1.58-1ubuntu1\r\n\tapt mysql-server 5.1.58-1ubuntu1\r\n\tapt mysql-server-5.1 5.1.58-1ubuntu1\r\n\tapt mysql-server-core-5.1 5.1.58-1ubuntu1\r\n\tapt nginx-common 1.0.5-1\r\n\tapt nginx-light 1.0.5-1\r\n\tapt openssh-server 1:5.8p1-7ubuntu1\r\n\tapt openssl 1.0.0e-2ubuntu4\r\n\tapt python-pip 1.0-1\r\n\tapt python-pkg-resources 0.6.16-1\r\n\tapt python-setuptools 0.6.16-1\r\n\tapt rsync 3.0.8-1ubuntu1\r\n\tapt ruby 4.8\r\n\tapt ruby-dev 4.8\r\n\tapt ruby1.8 1.8.7.352-2\r\n\tapt ruby1.8-dev 1.8.7.352-2\r\n\tapt rubygems 1.7.2-1\r\n\tapt tmux 1.5-1\r\n\tpython-pip Django 1.3.1\r\n\trubygems fpm 0.3.11\r\n\trubygems hpricot 0.8.5\r\n\trubygems json 1.6.3\r\n\trubygems kgio 2.6.0\r\n\trubygems mustache 0.99.4\r\n\trubygems rack 1.3.5\r\n\trubygems rack-protection 1.1.4\r\n\trubygems raindrops 0.8.0\r\n\trubygems rdiscount 1.6.8\r\n\trubygems sinatra 1.3.1\r\n\trubygems tilt 1.3.3\r\n\trubygems unicorn 4.1.1\r\n\r\n`blueprint show-services example`\r\n\r\n\tsysvinit nginx\r\n\tsysvinit ssh\r\n\tupstart example\r\n\tupstart mysql\r\n\r\n`blueprint show-sources example`\r\n\r\n\t/usr/local 82789250f3ad94d4cfeacc0a8cabae2d26b0270e.tar\r\n\tdrwxr-xr-x root/root         0 2011-11-29 21:42 ./\r\n\tdrwxr-xr-x root/root         0 2011-11-29 20:50 ./share/\r\n\tdrwxr-xr-x root/root         0 2011-11-29 21:55 ./share/rack/\r\n\tdrwxr-xr-x rcrowley/rcrowley 0 2011-12-09 15:12 ./share/rack/example/\r\n\t-rw-rw-r-- rcrowley/rcrowley 55 2011-11-29 21:02 ./share/rack/example/app.rb\r\n\t-rw-rw-r-- rcrowley/rcrowley 39 2011-11-29 20:54 ./share/rack/example/config.ru\r\n\r\nWe're off to a great start but there are some extraneous files and packages here that need cleaning up.\r\n\r\n----\r\n\r\n<h1 id=\"ignore\">Ignoring particular resources</h1>\r\n\r\nRather than requiring you enumerate every detail of your infrastructure in code, Blueprint reverse-engineers most of these details from running systems.  There are times, though, when it's a bit too verbose.\r\n\r\nInspired by similar features in version control software, Blueprint allows you to enumerate files, packages, services, and sources that should be ignored in a file format inspired by `gitignore`(5).  See `blueprintignore`(5) for details.\r\n\r\nBlueprint looks for these rules in `/etc/blueprintignore` and `~/.blueprintignore`.  Rules in `/etc/blueprintignore` will be included in the blueprint itself, thereby propagating to other users of the blueprint.  Rules in `~/.blueprintignore` will remain local though each revision of a blueprint will store the full set of rules used to create it.\r\n\r\nFiles may be specified by fully-qualified or relative pathnames, possibly including glob syntax:\r\n\r\n\t/etc/foo\r\n\tfoo/*\r\n\t*.foo\r\n\t[abc]/[xyz]\r\n\r\nPackages must be specified by their manager and name, prefixed with `:package:`:\r\n\r\n\t:package:apt/build-essential\r\n\r\nWhen a package is ignored, packages on which it depends are also ignored.\r\n\r\nServices must be specified by their manager and name, prefixed with `:service:`:\r\n\r\n\t:service:sysvinit/ssh\r\n\r\nSources must be specified by fully-qualified pathnames:\r\n\r\n\t:sources:/usr/local\r\n\r\nYou can ignore and unignore particular files within a source directory to fine-tune what's included in the tarball.\r\n\r\nAny rule may be negated by prefixing it with a `!`, which overrides defaults and well as previous matching rules - the last matching rule wins.\r\n\r\nExample\r\n-------\r\n\r\n`/etc/apt/sources.list` and `/etc/hosts` really don't belong in the blueprint since they're part of the operating system and we haven't customized them.  Add their pathnames to `/etc/blueprintignore`:\r\n\r\n\t/etc/apt/sources.list\r\n\t/etc/hosts\r\n\r\n`/etc/mysql/debian.cnf` is generated by the MySQL server package in its `postinst` maintainer script.  Add its pathname to `/etc/blueprintignore`:\r\n\r\n\t/etc/mysql/debian.cnf\r\n\r\n`/etc/nginx/sites-enabled/default` is part of the basic Nginx installation and again we don't particularly care about it.  Add its pathname to `/etc/blueprintignore`:\r\n\r\n\t/etc/nginx/sites-enabled/default\r\n\r\n`build-essential` brought a lot of friends along that are clouding what's really important in this blueprint.  Recall that ignoring a package also ignores its dependencies.  The opposite is not true: unignoring a package leaves its dependencies alone.  Ignoring and immediately unignoring `build-essential`, `ruby`, and `ruby-dev` will slim down the blueprint without any loss in completeness.\r\n\r\n\t:package:apt/build-essential\r\n\t!:package:apt/build-essential\r\n\t:package:apt/ruby\r\n\t!:package:apt/ruby\r\n\t:package:apt/ruby-dev\r\n\t!:package:apt/ruby-dev\r\n\r\nRunning `sudo blueprint create example` again will commit a new blueprint that takes these rules into account.\r\n\r\n----\r\n\r\n<h1 id=\"rules\">Rules files and blueprint-rules</h1>\r\n\r\nAs complexity grows, you're likely to pass an inflection point when it becomes easier to enumerate the resources you care about, not the resources that should be ignored.  When the time comes, Blueprint is ready.  The rules syntax used to ignore particular resources can be turned around and used to enumerate the resources to include in the blueprint.  See `blueprint-rules`(5) for details.\r\n\r\nThe `blueprint-rules`(1) command reverse-engineers the system just like `blueprint-create` but limits the resources included in the blueprint to those in the rules file.\r\n\r\n<pre><code>blueprint rules <em>pathname</em></code></pre>\r\n\r\nThe rules files are a bit of a hybrid between the traditional Blueprint approach of reverse-engineering and the typical configuration-as-code approach of other configuration management tools.\r\n\r\nExample\r\n-------\r\n\r\nAdd these rules to `example.blueprint-rules`:\r\n\r\n\t:source:/usr/local\r\n\t/etc/init/example.conf\r\n\t/etc/nginx/sites-*/example\r\n\t:package:apt/libmysqlclient-dev\r\n\t:package:apt/mysql-client-5.1\r\n\t:package:apt/nginx-common\r\n\t:package:apt/nginx-light\r\n\t:package:apt/ruby-dev\r\n\t:package:apt/rubygems\r\n\t:package:rubygems/*\r\n\t:service:sysvinit/nginx\r\n\t:service:upstart/example\r\n\r\nNow create the blueprint `example`:\r\n\r\n\tblueprint rules example.blueprint-rules\r\n\r\nAs usual, the blueprint is stored locally in Git, ready for action.\r\n\r\nA good exercise for the reader is creation of a separate blueprint for the MySQL server and its configuration.  It's installed alongside the web stack in development but that's unlikely to be the case in production, so having two blueprints could be advantageous.  The next chapter introduces another way to create two blueprints from one system.\r\n\r\n----\r\n\r\n<h1 id=\"diff-split-prune\">Diffing, splitting and pruning existing blueprints</h1>\r\n\r\nRefactoring is a major part of software development practice and configuration management shouldn't be left out in the cold.  Blueprint provides several tools that can be used to refactor your blueprints into more modular, maintainable, focused artifacts.\r\n\r\n`blueprint-diff`(1) takes direct advantage of the subtraction operator available on `Blueprint` objects in the underlying library.\r\n\r\n<pre><code>blueprint diff <em>minuend</em> <em>subtrahend</em> <em>difference</em></code></pre>\r\n\r\nResources that appear in _minuend_ but not _subtrahend_ will be included in _difference_ and committed to the local Git repository under that name.\r\n\r\n`blueprint-split`(1) and `blueprint-prune`(1) are interactive refactoring tools.\r\n\r\n`blueprint-split` prints each resource in _src_ and prompts you for a choice of _dest-a_ or _dest-b_.  The resulting _dest-a_ and _dest-b_ blueprints are committed to the local Git repository.\r\n\r\n<pre><code>blueprint split <em>src</em> <em>dest-a</em> <em>dest-b</em></code></pre>\r\n\r\n`blueprint-prune` instead prompts you to include or ignore each resource in _src_ in _dest_.\r\n\r\n<pre><code>blueprint prune <em>src</em> <em>dest</em></code></pre>\r\n\r\nThere are some limitations in both of these tools, however.  You can't currently split the files within a source tarball.  The best workaround is to use rules files to create blueprints that contain only the files you want.\r\n\r\nExample\r\n-------\r\n\r\n`blueprint prune example example-nginx`\r\n\r\n\t/usr/local 6326b42413443bc2d94e13747d05f650b873a53e.tar\r\n\tInclude in blueprint example-nginx? [y/n] n\r\n\t/etc/init/example.conf\r\n\tInclude in blueprint example-nginx? [y/n] n\r\n\t/etc/nginx/sites-available/example\r\n\tInclude in blueprint example-nginx? [y/n] y\r\n\t/etc/nginx/sites-enabled/example\r\n\tInclude in blueprint example-nginx? [y/n] y\r\n\tapt nginx-common 1.0.5-1\r\n\tInclude in blueprint example-nginx? [y/n] y\r\n\tapt nginx-light 1.0.5-1\r\n\tInclude in blueprint example-nginx? [y/n] y\r\n\tapt ruby-dev 4.8\r\n\tInclude in blueprint example-nginx? [y/n] n\r\n\tapt rubygems 1.7.2-1\r\n\tInclude in blueprint example-nginx? [y/n] n\r\n\trubygems fpm 0.3.11\r\n\tInclude in blueprint example-nginx? [y/n] n\r\n\trubygems hpricot 0.8.5\r\n\tInclude in blueprint example-nginx? [y/n] n\r\n\trubygems json 1.6.3\r\n\tInclude in blueprint example-nginx? [y/n] n\r\n\trubygems kgio 2.6.0\r\n\tInclude in blueprint example-nginx? [y/n] n\r\n\trubygems mustache 0.99.4\r\n\tInclude in blueprint example-nginx? [y/n] n\r\n\trubygems rack 1.3.5\r\n\tInclude in blueprint example-nginx? [y/n] n\r\n\trubygems rack-protection 1.1.4\r\n\tInclude in blueprint example-nginx? [y/n] n\r\n\trubygems raindrops 0.8.0\r\n\tInclude in blueprint example-nginx? [y/n] n\r\n\trubygems rdiscount 1.6.8\r\n\tInclude in blueprint example-nginx? [y/n] n\r\n\trubygems sinatra 1.3.1\r\n\tInclude in blueprint example-nginx? [y/n] n\r\n\trubygems tilt 1.3.3\r\n\tInclude in blueprint example-nginx? [y/n] n\r\n\trubygems unicorn 4.1.1\r\n\tInclude in blueprint example-nginx? [y/n] n\r\n\tsysvinit nginx\r\n\tInclude in blueprint example-nginx? [y/n] y\r\n\tupstart example\r\n\tInclude in blueprint example-nginx? [y/n] n\r\n\r\nThe same could have been done with `blueprint-split` to create `example-nginx` and `example-mysql` or `base` and `custom` &mdash; any distinction you desire.\r\n\r\n----\r\n\r\n<h1 id=\"templates\">Rendering templates of configuration files</h1>\r\n\r\nNot all systems are created equal.  Certainly your `m2.4xlarge` AWS EC2 instance packs a bit more CPU than a virtual machine running in a corner of your laptop and your configurations should be able to cope with these operational extremes.\r\n\r\nBlueprint allows configuration files (found in `/etc`) to be specified as templates and (optionally) data rather than static content.  These templates are rendered by a special portable dialect of the `mustache`(5) template language called `mustache.sh`.  See `blueprint-template`(5) for details.\r\n\r\nIn their simplest form, these templates allow substitution of system parameters.\r\n\r\n<pre><code>&#123;&#123;<em>FOO</em>&#125;&#125;</code></pre>\r\n\r\nYou can also substitute the output of a shell command.\r\n\r\n<pre><code>&#123;&#123;`<em>echo foo</em>`&#125;&#125;</code></pre>\r\n\r\nMore complex uses can iterate over the lines of output from a shell command.\r\n\r\n<pre><code>&#123;&#123;#`<em>echo foo; echo bar; echo baz</em>`&#125;&#125;<br />&#123;&#123;_M_LINE&#125;&#125;<br />&#123;&#123;/`<em>echo foo; echo bar; echo baz</em>`&#125;&#125;</code></pre>\r\n\r\nBlueprint ships with a small helping of common system parameters:\r\n\r\n* `CORES`: the number of CPU cores in the system.\r\n* `MEM`: the total amount of memory in the system in bytes.\r\n* `FQDN`: the fully-qualified domain name according to `hostname`(1)'s `--fqdn` option.\r\n* `PRIVATE_IP`: the first private IPv4 address assigned to any interface.\r\n* `PUBLIC_IP`: the first public IPv4 address assigned to any interface.\r\n\r\nThere are several more, documented in `blueprint-template`(7).  You can provide your own global data by adding `source`-able shell scripts with the `.sh` suffix to `/etc/blueprint-template.d`.\r\n\r\nAny _pathname_ may have an associated template, <code><em>pathname</em>.blueprint-template.mustache</code>.  An additional `source`-able shell script private to just this template may be placed in <code><em>pathname</em>.blueprint-template.sh</code>.\r\n\r\nTo render a template locally (likely during development), use `blueprint-template(1)`.\r\n\r\n<pre><code>blueprint template <em>pathname</em></code></pre>\r\n\r\nExample\r\n-------\r\n\r\nOur Unicorn configuration statically assumes four workers is the best configuration.  In reality, Unicorn workers are a function of the number of CPU cores available.\r\n\r\nConfigure Unicorn to use one worker per CPU in `/etc/unicorn.conf.rb.blueprint-template.mustache`:\r\n\r\n<pre><code>worker_processes &#123;&#123;CORES&#125;&#125;</code></pre>\r\n\r\nConfigure Unicorn to use four workers per CPU in `/etc/unicorn.conf.rb.blueprint-template.mustache`:\r\n\r\n<pre><code>worker_processes &#123;&#123;`expr 4 \\* $CORES`&#125;&#125;</code></pre>\r\n\r\nOr, you can extract computation out of the template and into `/etc/unicorn.conf.rb.blueprint-template.sh`:\r\n\r\n\texport WORKER_PROCESSES=\"$(expr 4 \\* $CORES)\"\r\n\r\n`/etc/unicorn.conf.rb.blueprint-template.mustache` becomes:\r\n\r\n<pre><code>worker_processes &#123;&#123;WORKER_PROCESSES&#125;&#125;</code></pre>\r\n\r\nNow Blueprint can scale this Unicorn configuration up and down as the system allows or requires.\r\n\r\n----\r\n\r\n<h1 id=\"services\">Controlling service restart conditions</h1>\r\n\r\nThe last step in applying a blueprint is to restart all the services whose configuration changed.  Most configuration management tools require you to connect the dots explicitly but Blueprint finds many of those relationships automatically.\r\n\r\nSystem V init and Upstart services are included in blueprints when their init script or configuration file, or the package that contains the init script or configuration file, are included in the blueprint.  From there, Blueprint searches for resources that, when changed, should cause the service to restart.\r\n\r\n* When the package that contains the service init script or configuration file is upgraded, the service should be restarted.\r\n* When other files in the package that contains the service change, the service should be restarted.\r\n* When files in directories in the package that contains the service change, the service should be restarted.\r\n* When fully-qualified pathnames (be they files or directories) mentioned in the service init script or configuration file are changed, the service should be restarted.  This accounts for both changes to individual files and changes in source tarballs.\r\n\r\nOther files may be added to the list to watch by naming them in a comment in the service init script or configuration file.\r\n\r\nExample\r\n-------\r\n\r\nSuppose our `example` application reads `/etc/database.yml` for database connection credentials.  The Unicorn application server must be restarted to read changes to this file.  Mention `/etc/database.yml` in the Upstart configuration:\r\n\r\n\tdescription \"Example\"\r\n\tstart on runlevel [2345]\r\n\tstop on runlevel [!2345]\r\n\trespawn\r\n\tchdir /usr/local/share/rack/example\r\n\texec unicorn -c /etc/unicorn.conf.rb\r\n\t# Dear Blueprint, restart me when /etc/database.yml changes.\r\n\r\n----\r\n\r\n<h1 id=\"sh\">Generating POSIX shell scripts</h1>\r\n\r\nBeneath the `blueprint-apply`(1) command briefly introduced before there is the `-S` option to `blueprint-show`(1) which generates a POSIX shell script that can apply a blueprint to any system.\r\n\r\nDependencies are especially painful when bootstrapping new systems so Blueprint takes great pains to generate dependency-free shell scripts.  They extract source tarballs, place file contents and adjust owners/groups/modes, install packages, and restart services as necessary according to the algorithm described in `blueprint`(5).  Even template rendering is handled without any dependencies.\r\n\r\nThe generated shell script for the blueprint _name_ is written to a file in your working directory as <code><em>name</em>.sh</code> or <code><em>name</em>/bootstrap.sh</code> if the blueprint contains templates or source tarballs.\r\n\r\n<pre><code>blueprint show -S <em>name</em></code></pre>\r\n\r\nThis shell script and its associated files can drive deployment, provisioning, or other development environments without even having to install Blueprint first.\r\n\r\nExample\r\n-------\r\n\r\nRunning `blueprint show -S example` creates `example/bootstrap.sh` as follows and bundles `mustache.sh` and the source tarball containing our example application.  `example/bootstrap.sh`:\r\n\r\n<pre><code>#\r\n# Automatically generated by blueprint(7).  Edit at your own risk.\r\n#\r\n\r\nset -x\r\n\r\ncd \"$(dirname \"$0\")\"\r\n\r\nmkdir -p \"/etc/init\"\r\ncat &gt;\"/etc/init/example.conf\" &lt;&lt;EOF\r\ndescription \"Example\"\r\nstart on runlevel [2345]\r\nstop on runlevel [!2345]\r\nrespawn\r\nchdir /usr/local/share/rack/example\r\nexec unicorn -c /etc/unicorn.conf.rb\r\n# Dear Blueprint, restart me when /etc/database.yml changes.\r\nEOF\r\nMD5SUM=\"$(md5sum \"/etc/nginx/sites-available/example\" 2&gt;/dev/null)\"\r\nmkdir -p \"/etc/nginx/sites-available\"\r\ncat &gt;\"/etc/nginx/sites-available/example\" &lt;&lt;EOF\r\nserver {\r\nlisten 80 default;\r\nlocation /static { root /usr/local/share/rack/example/static; }\r\nlocation / { proxy_pass http://127.0.0.1:8080; }\r\n}\r\nEOF\r\n[ \"$MD5SUM\" != \"$(md5sum \"/etc/nginx/sites-available/example\")\" ] &amp;&amp; SERVICE_sysvinit_nginx=1\r\nMD5SUM=\"$(md5sum \"/etc/nginx/sites-enabled/example\" 2&gt;/dev/null)\"\r\nmkdir -p \"/etc/nginx/sites-enabled\"\r\nln -s \"/etc/nginx/sites-available/example\" \"/etc/nginx/sites-enabled/example\"\r\n[ \"$MD5SUM\" != \"$(md5sum \"/etc/nginx/sites-enabled/example\")\" ] &amp;&amp; SERVICE_sysvinit_nginx=1\r\nMD5SUM=\"$(md5sum \"/etc/unicorn.conf.rb\" 2&gt;/dev/null)\"\r\nmkdir -p \"/etc\"\r\n(\r\nset +x\r\n. \"lib/mustache.sh\"\r\nfor F in */blueprint-template.d/*.sh\r\ndo\r\n    . \"$F\"\r\ndone\r\nexport WORKER_PROCESSES=\"$(expr 4 \\* $CORES)\"\r\nmustache &gt;\"/etc/unicorn.conf.rb\" &lt;&lt;EOF\r\nworker_processes &#123;&#123;WORKER_PROCESSES&#125;&#125;\r\nEOF\r\n)\r\n[ \"$MD5SUM\" != \"$(md5sum \"/etc/unicorn.conf.rb\")\" ] &amp;&amp; SERVICE_upstart_example=1\r\nexport APT_LISTBUGS_FRONTEND=\"none\"\r\nexport APT_LISTCHANGES_FRONTEND=\"none\"\r\nexport DEBIAN_FRONTEND=\"noninteractive\"\r\napt-get -q update\r\n[ \"$(dpkg-query -f'${Version}\\n' -W mysql-client-5.1)\" = \"5.1.58-1ubuntu1\" ] || apt-get -y -q -o DPkg::Options::=--force-confold install mysql-client-5.1=5.1.58-1ubuntu1\r\n[ \"$(dpkg-query -f'${Version}\\n' -W nginx-common)\" = \"1.0.5-1\" ] || { apt-get -y -q -o DPkg::Options::=--force-confold install nginx-common=1.0.5-1; SERVICE_sysvinit_nginx=1; }\r\n[ \"$(dpkg-query -f'${Version}\\n' -W nginx-light)\" = \"1.0.5-1\" ] || apt-get -y -q -o DPkg::Options::=--force-confold install nginx-light=1.0.5-1\r\n[ \"$(dpkg-query -f'${Version}\\n' -W ruby-dev)\" = \"4.8\" ] || apt-get -y -q -o DPkg::Options::=--force-confold install ruby-dev=4.8\r\n[ \"$(dpkg-query -f'${Version}\\n' -W rubygems)\" = \"1.7.2-1\" ] || apt-get -y -q -o DPkg::Options::=--force-confold install rubygems=1.7.2-1\r\ngem -i -v0.3.11 fpm &gt;/dev/null || gem install --no-rdoc --no-ri -v0.3.11 fpm\r\ngem -i -v0.8.5 hpricot &gt;/dev/null || gem install --no-rdoc --no-ri -v0.8.5 hpricot\r\ngem -i -v1.6.3 json &gt;/dev/null || gem install --no-rdoc --no-ri -v1.6.3 json\r\ngem -i -v2.6.0 kgio &gt;/dev/null || gem install --no-rdoc --no-ri -v2.6.0 kgio\r\ngem -i -v0.99.4 mustache &gt;/dev/null || gem install --no-rdoc --no-ri -v0.99.4 mustache\r\ngem -i -v1.3.5 rack &gt;/dev/null || gem install --no-rdoc --no-ri -v1.3.5 rack\r\ngem -i -v1.1.4 rack-protection &gt;/dev/null || gem install --no-rdoc --no-ri -v1.1.4 rack-protection\r\ngem -i -v0.8.0 raindrops &gt;/dev/null || gem install --no-rdoc --no-ri -v0.8.0 raindrops\r\ngem -i -v1.6.8 rdiscount &gt;/dev/null || gem install --no-rdoc --no-ri -v1.6.8 rdiscount\r\ngem -i -v1.3.1 sinatra &gt;/dev/null || gem install --no-rdoc --no-ri -v1.3.1 sinatra\r\ngem -i -v1.3.3 tilt &gt;/dev/null || gem install --no-rdoc --no-ri -v1.3.3 tilt\r\ngem -i -v4.1.1 unicorn &gt;/dev/null || gem install --no-rdoc --no-ri -v4.1.1 unicorn\r\n[ -n \"$SERVICE_sysvinit_nginx\" ] &amp;&amp; /etc/init.d/nginx restart\r\n[ -n \"$SERVICE_upstart_example\" ] &amp;&amp; { restart example || start example; }</code></pre>\r\n\r\n----\r\n\r\n<h1 id=\"push-pull\">Sharing and distributing blueprints</h1>\r\n\r\n**DevStructure runs a free Blueprint Server at `devstructure.com` but this service will not be available after June 30<sup>th</sup>, 2012.**  Learn more about [running your own Blueprint Server](#server)\r\n\r\nWe at DevStructure saw the workflow unfolding around these generated shell scripts and in them an opportunity for a macro don't-repeat-yourself optimization.  Thus were born `blueprint-push`(1) and `blueprint-pull`(1).\r\n\r\nIf you decide to [run your own Blueprint Server](#server), you'll need to configure a `server` ahead of time in `/etc/blueprint.cfg`:\r\n\r\n<pre><code>[io]\r\nserver = <em>server</em></code></pre>\r\n\r\n`blueprint-push` uploads the JSON document and all source tarballs referenced by a blueprint to a Blueprint Server, which stores them behind a long secret key in AWS S3.  The URL that may be used to pull the blueprint later is printed to standard output.\r\n\r\n<pre><code>blueprint push <em>name</em></code></pre>\r\n\r\nThe first time you run this command it will prompt you with the contents of `/etc/blueprint.cfg` which you can optionally put in place.  If you do, Blueprint will reuse the same secret the next time `blueprint-push` is called.  Configuring a secret this way allows you to push revisions to your blueprints which can then be pulled from a known location.\r\n\r\n`blueprint-pull` downloads the JSON document and all source tarballs referenced by a blueprint that has been pushed and stores them in the local Git repository.  Typically, it accepts the URL printed by `blueprint-push` but if you configure a default secret in `/etc/blueprint.cfg`, you can pull blueprints by only their name.\r\n\r\n<pre><code>blueprint pull <em>url</em></code></pre>\r\n\r\n<pre><code>blueprint pull <em>name</em></code></pre>\r\n\r\nJust as `blueprint-show`'s `-S` option helps bootstrap systems with zero dependencies, `devstructure.com` can generate shell scripts remotely so Blueprint doesn't have to be installed ahead of time.  You can bootstrap a new system from a pushed blueprint in one command:\r\n\r\n<pre><code>curl https://devstructure.com/<em>secret</em>/<em>name</em>/<em>name</em>.sh | sh</code></pre>\r\n\r\nExample\r\n-------\r\n\r\nPush the _example_ blueprint to `devstructure.com`:\r\n\r\n\tblueprint push example\r\n\r\nNow configure a production system to apply the latest revision to _example_ every half hour (this behavior should be familiar to Puppet and Chef users).  In `root`'s crontab:\r\n\r\n\t*/30 * * * * curl https://devstructure.com/0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz_-/example/example.sh | sh\r\n\r\n----\r\n\r\n<h1 id=\"puppet-chef\">Generating Puppet modules and Chef cookbooks</h1>\r\n\r\nBlueprint can also streamline the development workflow in Puppet- or Chef-managed environments by generating complete Puppet modules or Chef cookbooks.\r\n\r\nGenerate a Puppet module in <code><em>name</em>/manifests/init.pp</code>:\r\n\r\n<pre><code>blueprint show -P <em>name</em></code></pre>\r\n\r\nGenerate a Chef cookbook in <code><em>name</em>/recipes/default.rb</code>:\r\n\r\n<pre><code>blueprint show -C <em>name</em></code></pre>\r\n\r\nThese modules and cookbooks may be included directly in any Puppet or Chef environment or be used as the starting point for further development &mdash; the code is formatted according to the style guidelines of the respective communities.\r\n\r\nNote, however, that the file templates used by Blueprint are incompatible with Puppet and Chef and so can't be included in the generated modules and cookbooks.\r\n\r\nExample\r\n-------\r\n\r\nRunning `blueprint show -P example` creates `example/manifests/init.pp` as follows and bundles the source tarball containing our example application.  `example/manifests/init.pp`:\r\n\r\n\t#\r\n\t# Automatically generated by blueprint(7).  Edit at your own risk.\r\n\t#\r\n\tclass example {\r\n\t\tExec {\r\n\t\t\tpath => '/home/rcrowley/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games',\r\n\t\t}\r\n\t\tClass['sources'] -> Class['files'] -> Class['packages']\r\n\t\tclass files {\r\n\t\t\tfile {\r\n\t\t\t\t'/etc':\r\n\t\t\t\t\tensure => directory;\r\n\t\t\t\t'/etc/init':\r\n\t\t\t\t\tensure => directory;\r\n\t\t\t\t'/etc/init/example.conf':\r\n\t\t\t\t\tcontent => template('example/etc/init/example.conf'),\r\n\t\t\t\t\tensure  => file,\r\n\t\t\t\t\tgroup   => root,\r\n\t\t\t\t\tmode    => 0644,\r\n\t\t\t\t\towner   => root;\r\n\t\t\t\t'/etc/nginx':\r\n\t\t\t\t\tensure => directory;\r\n\t\t\t\t'/etc/nginx/sites-available':\r\n\t\t\t\t\tensure => directory;\r\n\t\t\t\t'/etc/nginx/sites-available/example':\r\n\t\t\t\t\tcontent => template('example/etc/nginx/sites-available/example'),\r\n\t\t\t\t\tensure  => file,\r\n\t\t\t\t\tgroup   => root,\r\n\t\t\t\t\tmode    => 0644,\r\n\t\t\t\t\towner   => root;\r\n\t\t\t\t'/etc/nginx/sites-enabled':\r\n\t\t\t\t\tensure => directory;\r\n\t\t\t\t'/etc/nginx/sites-enabled/example':\r\n\t\t\t\t\tensure => '/etc/nginx/sites-available/example',\r\n\t\t\t\t\tgroup  => root,\r\n\t\t\t\t\towner  => root;\r\n\t\t\t\t'/etc/unicorn.conf.rb':\r\n\t\t\t\t\tcontent => template('example/etc/unicorn.conf.rb'),\r\n\t\t\t\t\tensure  => file,\r\n\t\t\t\t\tgroup   => root,\r\n\t\t\t\t\tmode    => 0644,\r\n\t\t\t\t\towner   => root;\r\n\t\t\t}\r\n\t\t}\r\n\t\tinclude files\r\n\t\tclass packages {\r\n\t\t\tClass['apt'] -> Class['rubygems']\r\n\t\t\texec { 'apt-get -q update':\r\n\t\t\t\tbefore => Class['apt'],\r\n\t\t\t}\r\n\t\t\tclass apt {\r\n\t\t\t\tpackage {\r\n\t\t\t\t\t'mysql-client-5.1':\r\n\t\t\t\t\t\tensure => '5.1.58-1ubuntu1';\r\n\t\t\t\t\t'nginx-common':\r\n\t\t\t\t\t\tensure => '1.0.5-1';\r\n\t\t\t\t\t'nginx-light':\r\n\t\t\t\t\t\tensure => '1.0.5-1';\r\n\t\t\t\t\t'ruby-dev':\r\n\t\t\t\t\t\tensure => '4.8';\r\n\t\t\t\t\t'rubygems':\r\n\t\t\t\t\t\tensure => '1.7.2-1';\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tinclude apt\r\n\t\t\tclass rubygems {\r\n\t\t\t\tpackage {\r\n\t\t\t\t\t'fpm':\r\n\t\t\t\t\t\tensure   => '0.3.11',\r\n\t\t\t\t\t\tprovider => gem;\r\n\t\t\t\t\t'hpricot':\r\n\t\t\t\t\t\tensure   => '0.8.5',\r\n\t\t\t\t\t\tprovider => gem;\r\n\t\t\t\t\t'json':\r\n\t\t\t\t\t\tensure   => '1.6.3',\r\n\t\t\t\t\t\tprovider => gem;\r\n\t\t\t\t\t'kgio':\r\n\t\t\t\t\t\tensure   => '2.6.0',\r\n\t\t\t\t\t\tprovider => gem;\r\n\t\t\t\t\t'mustache':\r\n\t\t\t\t\t\tensure   => '0.99.4',\r\n\t\t\t\t\t\tprovider => gem;\r\n\t\t\t\t\t'rack':\r\n\t\t\t\t\t\tensure   => '1.3.5',\r\n\t\t\t\t\t\tprovider => gem;\r\n\t\t\t\t\t'rack-protection':\r\n\t\t\t\t\t\tensure   => '1.1.4',\r\n\t\t\t\t\t\tprovider => gem;\r\n\t\t\t\t\t'raindrops':\r\n\t\t\t\t\t\tensure   => '0.8.0',\r\n\t\t\t\t\t\tprovider => gem;\r\n\t\t\t\t\t'rdiscount':\r\n\t\t\t\t\t\tensure   => '1.6.8',\r\n\t\t\t\t\t\tprovider => gem;\r\n\t\t\t\t\t'sinatra':\r\n\t\t\t\t\t\tensure   => '1.3.1',\r\n\t\t\t\t\t\tprovider => gem;\r\n\t\t\t\t\t'tilt':\r\n\t\t\t\t\t\tensure   => '1.3.3',\r\n\t\t\t\t\t\tprovider => gem;\r\n\t\t\t\t\t'unicorn':\r\n\t\t\t\t\t\tensure   => '4.1.1',\r\n\t\t\t\t\t\tprovider => gem;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tinclude rubygems\r\n\t\t}\r\n\t\tinclude packages\r\n\t\tclass services {\r\n\t\t\tclass sysvinit {\r\n\t\t\t\tservice { 'nginx':\r\n\t\t\t\t\tenable    => true,\r\n\t\t\t\t\tensure    => running,\r\n\t\t\t\t\tsubscribe => [File['/etc/nginx/sites-available/example'], File['/etc/nginx/sites-enabled/example'], Package['nginx-common'], Exec['82789250f3ad94d4cfeacc0a8cabae2d26b0270e.tar']],\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tinclude sysvinit\r\n\t\t\tclass upstart {\r\n\t\t\t\tservice { 'example':\r\n\t\t\t\t\tenable    => true,\r\n\t\t\t\t\tensure    => running,\r\n\t\t\t\t\tprovider  => upstart,\r\n\t\t\t\t\tsubscribe => [File['/etc/unicorn.conf.rb'], Exec['82789250f3ad94d4cfeacc0a8cabae2d26b0270e.tar']],\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tinclude upstart\r\n\t\t}\r\n\t\tinclude services\r\n\t\tclass sources {\r\n\t\t\texec { 'tar xf /tmp/82789250f3ad94d4cfeacc0a8cabae2d26b0270e.tar':\r\n\t\t\t\talias => '/usr/local',\r\n\t\t\t\tcwd   => '/usr/local',\r\n\t\t\t}\r\n\t\t\tfile { '/tmp/82789250f3ad94d4cfeacc0a8cabae2d26b0270e.tar':\r\n\t\t\t\tbefore => Exec['/usr/local'],\r\n\t\t\t\tgroup  => root,\r\n\t\t\t\tmode   => 0644,\r\n\t\t\t\towner  => root,\r\n\t\t\t\tsource => 'puppet:///modules/example/tmp/82789250f3ad94d4cfeacc0a8cabae2d26b0270e.tar',\r\n\t\t\t}\r\n\t\t}\r\n\t\tinclude sources\r\n\t}\r\n\r\nRunning `blueprint show -C example` creates `example/recipes/default.rb` as follows and bundles the source tarball containing our example application.  `example/recipes/default.rb`:\r\n\r\n\t#\r\n\t# Automatically generated by blueprint(7).  Edit at your own risk.\r\n\t#\r\n\tcookbook_file('/tmp/82789250f3ad94d4cfeacc0a8cabae2d26b0270e.tar') do\r\n\t  backup false\r\n\t  group 'root'\r\n\t  mode '0644'\r\n\t  owner 'root'\r\n\t  source 'tmp/82789250f3ad94d4cfeacc0a8cabae2d26b0270e.tar'\r\n\tend\r\n\texecute('tar xf \"/tmp/82789250f3ad94d4cfeacc0a8cabae2d26b0270e.tar\"') { cwd '/usr/local' }\r\n\tdirectory('/etc/init') do\r\n\t  group 'root'\r\n\t  mode '0755'\r\n\t  owner 'root'\r\n\t  recursive true\r\n\tend\r\n\tcookbook_file('/etc/init/example.conf') do\r\n\t  backup false\r\n\t  group 'root'\r\n\t  mode '0644'\r\n\t  owner 'root'\r\n\t  source 'etc/init/example.conf'\r\n\tend\r\n\tdirectory('/etc/nginx/sites-available') do\r\n\t  group 'root'\r\n\t  mode '0755'\r\n\t  owner 'root'\r\n\t  recursive true\r\n\tend\r\n\tcookbook_file('/etc/nginx/sites-available/example') do\r\n\t  backup false\r\n\t  group 'root'\r\n\t  mode '0644'\r\n\t  owner 'root'\r\n\t  source 'etc/nginx/sites-available/example'\r\n\tend\r\n\tdirectory('/etc/nginx/sites-enabled') do\r\n\t  group 'root'\r\n\t  mode '0755'\r\n\t  owner 'root'\r\n\t  recursive true\r\n\tend\r\n\tlink('/etc/nginx/sites-enabled/example') do\r\n\t  group 'root'\r\n\t  owner 'root'\r\n\t  to '/etc/nginx/sites-available/example'\r\n\tend\r\n\tdirectory('/etc') do\r\n\t  group 'root'\r\n\t  mode '0755'\r\n\t  owner 'root'\r\n\t  recursive true\r\n\tend\r\n\tcookbook_file('/etc/unicorn.conf.rb') do\r\n\t  backup false\r\n\t  group 'root'\r\n\t  mode '0644'\r\n\t  owner 'root'\r\n\t  source 'etc/unicorn.conf.rb'\r\n\tend\r\n\texecute('apt-get -q update')\r\n\tpackage('mysql-client-5.1') { version '5.1.58-1ubuntu1' }\r\n\tpackage('nginx-common') { version '1.0.5-1' }\r\n\tpackage('nginx-light') { version '1.0.5-1' }\r\n\tpackage('ruby-dev') { version '4.8' }\r\n\tpackage('rubygems') { version '1.7.2-1' }\r\n\tgem_package('fpm') { version '0.3.11' }\r\n\tgem_package('hpricot') { version '0.8.5' }\r\n\tgem_package('json') { version '1.6.3' }\r\n\tgem_package('kgio') { version '2.6.0' }\r\n\tgem_package('mustache') { version '0.99.4' }\r\n\tgem_package('rack') { version '1.3.5' }\r\n\tgem_package('rack-protection') { version '1.1.4' }\r\n\tgem_package('raindrops') { version '0.8.0' }\r\n\tgem_package('rdiscount') { version '1.6.8' }\r\n\tgem_package('sinatra') { version '1.3.1' }\r\n\tgem_package('tilt') { version '1.3.3' }\r\n\tgem_package('unicorn') { version '4.1.1' }\r\n\tservice('nginx') do\r\n\t  action [:enable, :start]\r\n\t  subscribes :restart, resources('cookbook_file[/etc/nginx/sites-available/example]', 'cookbook_file[/etc/nginx/sites-enabled/example]', 'package[nginx-common]', 'execute[82789250f3ad94d4cfeacc0a8cabae2d26b0270e.tar]')\r\n\tend\r\n\tservice('example') do\r\n\t  action [:enable, :start]\r\n\t  provider Chef::Provider::Service::Upstart\r\n\t  subscribes :restart, resources('cookbook_file[/etc/unicorn.conf.rb]', 'execute[82789250f3ad94d4cfeacc0a8cabae2d26b0270e.tar]')\r\n\tend\r\n\r\n----\r\n\r\n<h1 id=\"cloudformation\">Integrating with AWS CloudFormation</h1>\r\n\r\nProduction environments are much more than a rack of servers these days and nowhere is that more apparent than AWS.  Blueprint integrates with AWS CloudFormation to provision and bootstrap entire infrastructures declaratively.\r\n\r\nThe `--cfn` option to `blueprint-show`(1) generates the skeleton of a CloudFormation template that provisions a single EC2 instance running Amazon Linux (an RPM-based distribution supported by Amazon) which will apply the blueprint during its first boot.\r\n\r\nFile templates and source tarballs aren't supported seamlessly, however.  File templates can be recreated using CloudFormation's primitive string functions or an executable user-data.  Source tarballs may reference fully-qualified URLs.\r\n\r\nExample\r\n-------\r\n\r\nRunning `blueprint show --cfn example` creates `example.json`:\r\n\r\n\t{\r\n\t  \"AWSTemplateFormatVersion\": \"2010-09-09\", \r\n\t  \"Description\": \"Create an Amazon EC2 instance and bootstrap it as instructed by a blueprint.  This is intended to be a starting point for building larger architectures with AWS CloudFormation.  **WARNING** This template creates an Amazon EC2 instance.  You will be billed for the AWS resources used if you create a stack from this template.\", \r\n\t  \"Mappings\": {\r\n\t    \"AWSInstanceType2Arch\": {\r\n\t      \"c1.medium\": {\r\n\t        \"Arch\": \"32\"\r\n\t      }, \r\n\t      \"c1.xlarge\": {\r\n\t        \"Arch\": \"64\"\r\n\t      }, \r\n\t      \"cc1.4xlarge\": {\r\n\t        \"Arch\": \"64\"\r\n\t      }, \r\n\t      \"m1.large\": {\r\n\t        \"Arch\": \"64\"\r\n\t      }, \r\n\t      \"m1.small\": {\r\n\t        \"Arch\": \"32\"\r\n\t      }, \r\n\t      \"m1.xlarge\": {\r\n\t        \"Arch\": \"64\"\r\n\t      }, \r\n\t      \"m2.2xlarge\": {\r\n\t        \"Arch\": \"64\"\r\n\t      }, \r\n\t      \"m2.4xlarge\": {\r\n\t        \"Arch\": \"64\"\r\n\t      }, \r\n\t      \"m2.xlarge\": {\r\n\t        \"Arch\": \"64\"\r\n\t      }, \r\n\t      \"t1.micro\": {\r\n\t        \"Arch\": \"32\"\r\n\t      }\r\n\t    }, \r\n\t    \"AWSRegionArch2AMI\": {\r\n\t      \"ap-northeast-1\": {\r\n\t        \"32\": \"ami-dcfa4edd\", \r\n\t        \"64\": \"ami-e8fa4ee9\"\r\n\t      }, \r\n\t      \"ap-southeast-1\": {\r\n\t        \"32\": \"ami-74dda626\", \r\n\t        \"64\": \"ami-7edda62c\"\r\n\t      }, \r\n\t      \"eu-west-1\": {\r\n\t        \"32\": \"ami-24506250\", \r\n\t        \"64\": \"ami-20506254\"\r\n\t      }, \r\n\t      \"us-east-1\": {\r\n\t        \"32\": \"ami-7f418316\", \r\n\t        \"64\": \"ami-7341831a\"\r\n\t      }, \r\n\t      \"us-west-1\": {\r\n\t        \"32\": \"ami-951945d0\", \r\n\t        \"64\": \"ami-971945d2\"\r\n\t      }\r\n\t    }\r\n\t  }, \r\n\t  \"Outputs\": {\r\n\t    \"PublicDnsName\": {\r\n\t      \"Description\": \"Public DNS name of the EC2 instance.\", \r\n\t      \"Value\": {\r\n\t        \"Fn::GetAtt\": [\r\n\t          \"EC2Instance\", \r\n\t          \"PublicDnsName\"\r\n\t        ]\r\n\t      }\r\n\t    }\r\n\t  }, \r\n\t  \"Parameters\": {\r\n\t    \"InstanceType\": {\r\n\t      \"AllowedValues\": [\r\n\t        \"t1.micro\", \r\n\t        \"m1.small\", \r\n\t        \"m1.large\", \r\n\t        \"m1.xlarge\", \r\n\t        \"m2.xlarge\", \r\n\t        \"m2.2xlarge\", \r\n\t        \"m2.4xlarge\", \r\n\t        \"c1.medium\", \r\n\t        \"c1.xlarge\", \r\n\t        \"cc1.4xlarge\"\r\n\t      ], \r\n\t      \"ConstraintDescription\": \"must be a valid EC2 instance type.\", \r\n\t      \"Default\": \"m1.small\", \r\n\t      \"Description\": \"EC2 instance type.\", \r\n\t      \"Type\": \"String\"\r\n\t    }, \r\n\t    \"KeyName\": {\r\n\t      \"Description\": \"Name of an existing EC2 KeyPair to enable SSH access to the instances\", \r\n\t      \"Type\": \"String\"\r\n\t    }\r\n\t  }, \r\n\t  \"Resources\": {\r\n\t    \"CfnUser\": {\r\n\t      \"Properties\": {\r\n\t        \"Path\": \"/\", \r\n\t        \"Policies\": [\r\n\t          {\r\n\t            \"PolicyDocument\": {\r\n\t              \"Statement\": [\r\n\t                {\r\n\t                  \"Action\": \"cloudformation:DescribeStackResource\", \r\n\t                  \"Effect\": \"Allow\", \r\n\t                  \"Resource\": \"*\"\r\n\t                }\r\n\t              ]\r\n\t            }, \r\n\t            \"PolicyName\": \"root\"\r\n\t          }\r\n\t        ]\r\n\t      }, \r\n\t      \"Type\": \"AWS::IAM::User\"\r\n\t    }, \r\n\t    \"EC2Instance\": {\r\n\t      \"Metadata\": {\r\n\t        \"AWS::CloudFormation::Init\": {\r\n\t          \"config\": {\r\n\t            \"files\": {\r\n\t              \"/etc/init/example.conf\": {\r\n\t                \"content\": \"description \\\"Example\\\"\\nstart on runlevel [2345]\\nstop on runlevel [!2345]\\nrespawn\\nchdir /usr/local/share/rack/example\\nexec unicorn -c /etc/unicorn.conf.rb\\n# Dear Blueprint, restart me when /etc/database.yml changes.\\n\", \r\n\t                \"encoding\": \"plain\", \r\n\t                \"group\": \"root\", \r\n\t                \"mode\": \"100644\", \r\n\t                \"owner\": \"root\"\r\n\t              }, \r\n\t              \"/etc/nginx/sites-available/example\": {\r\n\t                \"content\": \"server {\\n\\tlisten 80 default;\\n\\tlocation /static { root /usr/local/share/rack/example/static; }\\n\\tlocation / { proxy_pass http://127.0.0.1:8080; }\\n}\\n\", \r\n\t                \"encoding\": \"plain\", \r\n\t                \"group\": \"root\", \r\n\t                \"mode\": \"100644\", \r\n\t                \"owner\": \"root\"\r\n\t              }, \r\n\t              \"/etc/nginx/sites-enabled/example\": {\r\n\t                \"content\": \"/etc/nginx/sites-available/example\", \r\n\t                \"encoding\": \"plain\", \r\n\t                \"group\": \"root\", \r\n\t                \"mode\": \"120777\", \r\n\t                \"owner\": \"root\"\r\n\t              }, \r\n\t              \"/etc/unicorn.conf.rb\": {\r\n\t                \"content\": \"worker_processes 4\\n\", \r\n\t                \"encoding\": \"plain\", \r\n\t                \"group\": \"root\", \r\n\t                \"mode\": \"100644\", \r\n\t                \"owner\": \"root\"\r\n\t              }\r\n\t            }, \r\n\t            \"packages\": {\r\n\t              \"apt\": {\r\n\t                \"mysql-client-5.1\": [\r\n\t                  \"5.1.58-1ubuntu1\"\r\n\t                ], \r\n\t                \"nginx-common\": [\r\n\t                  \"1.0.5-1\"\r\n\t                ], \r\n\t                \"nginx-light\": [\r\n\t                  \"1.0.5-1\"\r\n\t                ], \r\n\t                \"ruby-dev\": [\r\n\t                  \"4.8\"\r\n\t                ], \r\n\t                \"rubygems\": [\r\n\t                  \"1.7.2-1\"\r\n\t                ]\r\n\t              }, \r\n\t              \"rubygems\": {\r\n\t                \"fpm\": [\r\n\t                  \"0.3.11\"\r\n\t                ], \r\n\t                \"hpricot\": [\r\n\t                  \"0.8.5\"\r\n\t                ], \r\n\t                \"json\": [\r\n\t                  \"1.6.3\"\r\n\t                ], \r\n\t                \"kgio\": [\r\n\t                  \"2.6.0\"\r\n\t                ], \r\n\t                \"mustache\": [\r\n\t                  \"0.99.4\"\r\n\t                ], \r\n\t                \"rack\": [\r\n\t                  \"1.3.5\"\r\n\t                ], \r\n\t                \"rack-protection\": [\r\n\t                  \"1.1.4\"\r\n\t                ], \r\n\t                \"raindrops\": [\r\n\t                  \"0.8.0\"\r\n\t                ], \r\n\t                \"rdiscount\": [\r\n\t                  \"1.6.8\"\r\n\t                ], \r\n\t                \"sinatra\": [\r\n\t                  \"1.3.1\"\r\n\t                ], \r\n\t                \"tilt\": [\r\n\t                  \"1.3.3\"\r\n\t                ], \r\n\t                \"unicorn\": [\r\n\t                  \"4.1.1\"\r\n\t                ]\r\n\t              }\r\n\t            }, \r\n\t            \"services\": {\r\n\t              \"sysvinit\": {\r\n\t                \"nginx\": {\r\n\t                  \"enable\": true, \r\n\t                  \"ensureRunning\": true, \r\n\t                  \"files\": [\r\n\t                    \"/etc/nginx/sites-enabled/example\", \r\n\t                    \"/etc/nginx/sites-available/example\"\r\n\t                  ], \r\n\t                  \"packages\": {\r\n\t                    \"apt\": [\r\n\t                      \"nginx-common\"\r\n\t                    ]\r\n\t                  }, \r\n\t                  \"sources\": [\r\n\t                    \"/usr/local\"\r\n\t                  ]\r\n\t                }\r\n\t              }, \r\n\t              \"upstart\": {\r\n\t                \"example\": {\r\n\t                  \"enable\": true, \r\n\t                  \"ensureRunning\": true, \r\n\t                  \"files\": [\r\n\t                    \"/etc/unicorn.conf.rb\"\r\n\t                  ], \r\n\t                  \"sources\": [\r\n\t                    \"/usr/local\"\r\n\t                  ]\r\n\t                }\r\n\t              }\r\n\t            }, \r\n\t            \"sources\": {\r\n\t              \"/usr/local\": \"82789250f3ad94d4cfeacc0a8cabae2d26b0270e.tar\"\r\n\t            }\r\n\t          }\r\n\t        }\r\n\t      }, \r\n\t      \"Properties\": {\r\n\t        \"ImageId\": {\r\n\t          \"Fn::FindInMap\": [\r\n\t            \"AWSRegionArch2AMI\", \r\n\t            {\r\n\t              \"Ref\": \"AWS::Region\"\r\n\t            }, \r\n\t            {\r\n\t              \"Fn::FindInMap\": [\r\n\t                \"AWSInstanceType2Arch\", \r\n\t                {\r\n\t                  \"Ref\": \"InstanceType\"\r\n\t                }, \r\n\t                \"Arch\"\r\n\t              ]\r\n\t            }\r\n\t          ]\r\n\t        }, \r\n\t        \"InstanceType\": {\r\n\t          \"Ref\": \"InstanceType\"\r\n\t        }, \r\n\t        \"KeyName\": {\r\n\t          \"Ref\": \"KeyName\"\r\n\t        }, \r\n\t        \"SecurityGroups\": [\r\n\t          {\r\n\t            \"Ref\": \"SecurityGroup\"\r\n\t          }\r\n\t        ], \r\n\t        \"UserData\": {\r\n\t          \"Fn::Base64\": {\r\n\t            \"Fn::Join\": [\r\n\t              \"\", \r\n\t              [\r\n\t                \"#!/bin/bash\\n\", \r\n\t                \"/opt/aws/bin/cfn-init -s \", \r\n\t                {\r\n\t                  \"Ref\": \"AWS::StackName\"\r\n\t                }, \r\n\t                \" -r EC2Instance \", \r\n\t                \" --access-key \", \r\n\t                {\r\n\t                  \"Ref\": \"HostKeys\"\r\n\t                }, \r\n\t                \" --secret-key \", \r\n\t                {\r\n\t                  \"Fn::GetAtt\": [\r\n\t                    \"HostKeys\", \r\n\t                    \"SecretAccessKey\"\r\n\t                  ]\r\n\t                }, \r\n\t                \" --region \", \r\n\t                {\r\n\t                  \"Ref\": \"AWS::Region\"\r\n\t                }, \r\n\t                \"\\n\", \r\n\t                \"/opt/aws/bin/cfn-signal -e $? '\", \r\n\t                {\r\n\t                  \"Ref\": \"WaitHandle\"\r\n\t                }, \r\n\t                \"'\\n\"\r\n\t              ]\r\n\t            ]\r\n\t          }\r\n\t        }\r\n\t      }, \r\n\t      \"Type\": \"AWS::EC2::Instance\"\r\n\t    }, \r\n\t    \"HostKeys\": {\r\n\t      \"Properties\": {\r\n\t        \"UserName\": {\r\n\t          \"Ref\": \"CfnUser\"\r\n\t        }\r\n\t      }, \r\n\t      \"Type\": \"AWS::IAM::AccessKey\"\r\n\t    }, \r\n\t    \"SecurityGroup\": {\r\n\t      \"Properties\": {\r\n\t        \"GroupDescription\": \"SSH access only.\", \r\n\t        \"SecurityGroupIngress\": [\r\n\t          {\r\n\t            \"CidrIp\": \"0.0.0.0/0\", \r\n\t            \"FromPort\": \"22\", \r\n\t            \"IpProtocol\": \"tcp\", \r\n\t            \"ToPort\": \"22\"\r\n\t          }\r\n\t        ]\r\n\t      }, \r\n\t      \"Type\": \"AWS::EC2::SecurityGroup\"\r\n\t    }, \r\n\t    \"WaitCondition\": {\r\n\t      \"DependsOn\": \"EC2Instance\", \r\n\t      \"Properties\": {\r\n\t        \"Handle\": {\r\n\t          \"Ref\": \"WaitHandle\"\r\n\t        }, \r\n\t        \"Timeout\": \"600\"\r\n\t      }, \r\n\t      \"Type\": \"AWS::CloudFormation::WaitCondition\"\r\n\t    }, \r\n\t    \"WaitHandle\": {\r\n\t      \"Type\": \"AWS::CloudFormation::WaitConditionHandle\"\r\n\t    }\r\n\t  }\r\n\t}\r\n\r\n----\r\n\r\n<h1 id=\"deploy\">Deploying your application with Blueprint</h1>\r\n\r\nThe example running throughout this tutorial takes advantage of Blueprint's default handling of `/usr/local` to package up an example web application.  As an application grows, this can become muddled by other packages you install from source.\r\n\r\nBlueprint doesn't dictate how you deploy your applications but here are a few options play very nicely with Blueprint.\r\n\r\n* Build Debian packages or RPMs for your application.  These packages can include service init scripts or configuration files which Blueprint will take into account when restarting services after a deploy.\r\n* Use Blueprint to scaffold your application deployment and some other method (possibly via SSH tools like Capistrano or Fabric) to actually deploy.\r\n\r\nAnd remember to use templates to render configuration files appropriately in development, staging, and production.\r\n\r\n----\r\n\r\n<h1 id=\"git\">Local Git repository</h1>\r\n\r\nBlueprints are stored in the local Git repository `~/.blueprints.git`.  Direct access isn't typically needed but Blueprint comes with the `blueprint-git`(1) tool that simplifies the parameters to `git`(1) needed to use this repository.\r\n\r\nExample\r\n-------\r\n\r\nClone the entire local Git repository into `blueprints` in the working directory:\r\n\r\n\tblueprint git clone\r\n\r\nShow the diff, from Git's point-of-view, between the previous two revisions of the _example_ blueprint:\r\n\r\n\tblueprint git show example\r\n\r\nThe JSON document is pretty-printed for storage so Git's diffs will actually be meaningful.\r\n\r\n----\r\n\r\n<h1 id=\"server\">Running your own Blueprint Server</h1>\r\n\r\n**DevStructure runs a free Blueprint Server at `devstructure.com` but this service will not be available after June 30<sup>th</sup>, 2012.**\r\n\r\nRunning a Blueprint Server opens up the `blueprint-push`(1) and `blueprint-pull`(1) commands so you can store your blueprints remotely and share them with your team.\r\n\r\nThe Blueprint Server [protocols](#protocols) and [endpoints](#endpoints) are documented for adventurous users that want to implement their own client or server.\r\n\r\nInstallation\r\n------------\r\n\r\nPrerequisites:\r\n\r\n* [Boto](http://code.google.com/p/boto/)\r\n* [Flask](http://flask.pocoo.org)\r\n* [GUnicorn](http://gunicorn.org)\r\n\r\nInstall the prerequisites from PyPI:\r\n\r\n\tsudo pip install boto flask gunicorn\r\n\r\nThe rest of Blueprint Server comes bundled with Blueprint itself in the `blueprint.io.server` module.\r\n\r\nConfiguration\r\n-------------\r\n\r\nConfigure your Blueprint Server in `/etc/blueprint.cfg`:\r\n\r\n<pre><code>[s3]\r\naccess_key = <em>access_key</em>\r\nsecret_key = <em>secret_key</em>\r\nbucket = <em>bucket</em></code></pre>\r\n\r\nConfigure your other servers to communicate with the Blueprint Server in `/etc/blueprint.cfg`:\r\n\r\n<pre><code>[io]\r\nserver = <em>server</em></code></pre>\r\n\r\nSupervise Blueprint Server with Upstart on Ubuntu or CentOS 6:\r\n\r\n\tdescription \"Blueprint Server\"\r\n\r\n\tstart on runlevel [2345]\r\n\tstop on runlevel [!2345]\r\n\r\n\trespawn\r\n\r\n\tenv VIA=upstart\r\n\r\n\tpre-start exec mkdir -p /var/log/blueprint-server\r\n\r\n\texec gunicorn -p/var/run/blueprint-server.pid -b0.0.0.0:5000 -w4 blueprint.io.server:app >>/var/log/blueprint-server/error.log 2>&1\r\n\r\n\t# Mention /etc/blueprint.cfg so Blueprint will connect this service to that file.\r\n\r\nOther platforms will have similar production configurations.\r\n\r\nUsage\r\n-----\r\n\r\nStart the server in development mode:\r\n\r\n\tpython /usr/lib/python2.7/dist-packages/blueprint/io/server/__init__.py\r\n\r\n(Note that the pathname may be different on your system, particularly if you installed Blueprint from source or from PyPI.)\r\n\r\nStart the server in production mode running in the foreground:\r\n\r\n\tgunicorn blueprint.io.server:app\r\n\r\nSome sort of process supervision, like Upstart as shown above, is recommended for production use.\r\n\r\nExample\r\n-------\r\n\r\nFirst, start your Blueprint Server:\r\n\r\n\tstart blueprint-server\r\n\r\nPush one of your blueprints to the Blueprint Server for safe-keeping or sharing with others:\r\n\r\n\tblueprint push example\r\n\r\nPull a blueprint from the Blueprint Server to configure new development environments or extra production capacity:\r\n\r\n\tblueprint pull example\r\n\r\n----\r\n\r\n<h1 id=\"protocols\">Blueprint Server Protocols</h1>\r\n\r\nPrerequisite: obtain a secret key via the <code>GET /secret</code> endpoint.\r\n\r\nStoring a blueprint\r\n-------------------\r\n\r\n1. Store the JSON representation of a blueprint via the [<code>PUT /<em>secret</em>/<em>name</em></code>](#PUT-blueprint) endpoint.\r\n2. Store each tarball referenced in the `\"sources\"` object in the blueprint via the [<code>PUT /<em>secret</em>/<em>name</em>/<em>sha</em>.tar</code>](#PUT-tarball) endpoint.\r\n\r\nFetching a blueprint\r\n--------------------\r\n\r\n1. Fetch the JSON representation of a blueprint via the [<code>GET /<em>secret</em>/<em>name</em></code>](#GET-blueprint) endpoint.\r\n2. Fetch each tarball referenced in the `\"sources\"` object in the blueprint via the [<code>GET /<em>secret</em>/<em>name</em>/<em>sha</em>.tar</code>](#GET-tarball) endpoint.\r\n\r\nBootstrapping on AWS\r\n--------------------\r\n\r\n1. Fetch the user data script for a blueprint via the [<code>GET /<em>secret</em>/<em>name</em>/user-data.sh</code>](#GET-user-data) endpoint.\r\n2. Provision instances with the script as their user data via the AWS Management Console or an argument to the EC2 command-line tools.\r\n\r\nConfiguring production instances\r\n--------------------------------\r\n\r\nProduction instances can use blueprints without installing Blueprint (and therefore Git and friends) by asking the Blueprint I/O Server to generate POSIX shell code.\r\n\r\n1. Fetch the POSIX shell representation of the blueprint via the [<code>GET /<em>secret</em>/<em>name</em>/<em>name</em>.sh</code>](#GET-sh) endpoint.  The resulting program will fetch tarballs as needed via the [<code>GET /<em>secret</em>/<em>name</em>/<em>sha</em>.tar</code>](#GET-tarball) endpoint.\r\n2. <code>sh <em>name</em>.sh</code> interactively, at boot, or periodically via `cron`(8).\r\n\r\n----\r\n\r\n<h1 id=\"endpoints\">Blueprint Server Endpoints</h1>\r\n\r\n<h2 id=\"GET-secret\"><code>GET /secret</code></h2>\r\n\r\nCreate a new secret key known only to the caller.  This is the namespace beneath which the caller's blueprints are stored.\r\n\r\nResponses:\r\n\r\n* 201: success; the body contains a new 64-byte secret key.\r\n* 502: failure; the upstream storage service failed.\r\n\r\n<h2 id=\"PUT-blueprint\"><code>PUT /<em>secret</em>/<em>name</em></code></h2>\r\n\r\nStore the JSON representation of the blueprint _name_.  The `Content-Type` of the body must be `application/json`.\r\n\r\nParameters:\r\n\r\n* _secret_: a 64-byte identifier containing numbers, letters, underscores, and dashes.\r\n* _name_: a blueprint name; it may not contain whitespace or `/` characters.\r\n\r\nResponses:\r\n\r\n* 202: success; the blueprint was well-formed and stored; the body contains pre-signed URIs for uploading source tarballs.\r\n* 400: failure; the blueprint was not well-formed.\r\n* 502: failure; the upstream storage service failed.\r\n\r\n<h2 id=\"GET-blueprint\"><code>GET /<em>secret</em>/<em>name</em></code></h2>\r\n\r\nFetch the JSON representation of the blueprint _name_.\r\n\r\nParameters:\r\n\r\n* _secret_: a 64-byte identifier containing numbers, letters, underscores, and dashes.\r\n* _name_: a blueprint name; it may not contain whitespace or `/` characters.\r\n\r\nResponses:\r\n\r\n* 200: success; the body contains the JSON representation of the blueprint _name_.\r\n* 404: failure; the _secret_ or blueprint _name_ was not found.\r\n* 502: failure; the upstream storage service failed.\r\n\r\n<h2 id=\"PUT-tarball\"><code>PUT /<em>secret</em>/<em>name</em>/<em>sha</em>.tar</code></h2>\r\n\r\nStore a source tarball referenced by blueprint _name_.  The `Content-Type` of the body must be `application/x-tar`.\r\n\r\nParameters:\r\n\r\n* _secret_: a 64-byte identifier containing numbers, letters, underscores, and dashes.\r\n* _name_: a blueprint name; it may not contain whitespace or `/` characters.\r\n* _sha_: a 40-byte hexadecimal representation of a SHA1 sum.\r\n\r\nResponses:\r\n\r\n* 202: success; the tarball was stored.\r\n* 400: failure; the SHA1 sum of the body did not match _sha_.\r\n* 404: failure; the _secret_ or blueprint _name_ was not found.\r\n* 502: failure; the upstream storage service failed.\r\n\r\n<h2 id=\"GET-tarball\"><code>GET /<em>secret</em>/<em>name</em>/<em>sha</em>.tar</code></h2>\r\n\r\nFetch a source tarball referenced by blueprint _name_.\r\n\r\nParameters:\r\n\r\n* _secret_: a 64-byte identifier containing numbers, letters, underscores, and dashes.\r\n* _name_: a blueprint name; it may not contain whitespace or `/` characters.\r\n* _sha_: a 40-byte hexadecimal representation of a SHA1 sum.\r\n\r\nResponses:\r\n\r\n* 200: success; the body contains the `application/x-tar` content of the source tarball.\r\n* 404: failure; the _secret_, blueprint _name_, or _sha_ was not found.\r\n* 502: failure; the upstream storage service failed.\r\n\r\n<h2 id=\"GET-sh\"><code>GET /<em>secret</em>/<em>name</em>/<em>name</em>.sh</code></h2>\r\n\r\nFetch the POSIX shell representation of the blueprint _name_.  The resulting program will fetch tarballs as needed via the <code>GET /<em>secret</em>/<em>name</em>/<em>sha</em>.tar</code> endpoint.\r\n\r\nParameters:\r\n\r\n* _secret_: a 64-byte identifier containing numbers, letters, underscores, and dashes.\r\n* _name_: a blueprint name; it may not contain whitespace or `/` characters.\r\n\r\nResponses:\r\n\r\n* 200: success; the body contains the POSIX shell representation of the blueprint _name_.\r\n* 404: failure; the _secret_ or blueprint _name_ was not found.\r\n* 502: failure; the upstream storage service failed.\r\n\r\n<h2 id=\"GET-user-data\"><code>GET /<em>secret</em>/<em>name</em>/user-data.sh</code></h2>\r\n\r\nFetch POSIX shell commands to download and apply the blueprint _name_.  EC2 instances provisioned from an AMI with [`cloud-init`](https://help.ubuntu.com/community/CloudInit) will execute this program if given as user data.\r\n\r\nParameters:\r\n\r\n* _secret_: a 64-byte identifier containing numbers, letters, underscores, and dashes.\r\n* _name_: a blueprint name; it may not contain whitespace or `/` characters.\r\n\r\nResponses:\r\n\r\n* 200: success; the body contains the POSIX shell representation of the blueprint _name_.\r\n* 404: failure; the _secret_ or blueprint _name_ was not found.\r\n* 502: failure; the upstream storage service failed.\r\n\r\n----\r\n\r\n<h1 id=\"contributing\">Contributing to Blueprint</h1>\r\n\r\nBlueprint is open-source, BSD-licensed software.  Contributions are welcome via pull requests on GitHub.\r\n\r\n* Source code: <https://github.com/devstructure/blueprint>\r\n* Issue tracker: <https://github.com/devstructure/blueprint/issues>\r\n* Mailing list: <https://groups.google.com/forum/#!forum/blueprint-users>\r\n* IRC: [`irc.freenode.net#devstructure`](irc://freenode.net/devstructure)\r\n\r\n----\r\n\r\n<h1 id=\"alternatives\">Alternatives to Blueprint</h1>\r\n\r\nIf Blueprint's not your cup of tea, check out the following tools.  It's much better to have some form of configuration management than none at all.\r\n\r\n* [Puppet](http://docs.puppetlabs.com)\r\n* [Chef](http://wiki.opscode.com/display/chef/Home)\r\n* [Bcfg2](http://trac.mcs.anl.gov/projects/bcfg2/)\r\n* [CFEngine](http://cfengine.com/)\r\n* [Juju](http://juju.ubuntu.com/)\r\n","google":"","note":"Don't delete this file! It's used internally to help with page regeneration."}