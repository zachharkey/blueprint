<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="description" content="Blueprint : Reverse engineer server configuration" />

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>Blueprint</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/winstonford/blueprint">View on GitHub</a>

          <h1 id="project_title">Blueprint</h1>
          <h2 id="project_tagline">Reverse engineer server configuration</h2>

            <section id="downloads">
              <a class="zip_download_link" href="https://github.com/winstonford/blueprint/zipball/master">Download this project as a .zip file</a>
              <a class="tar_download_link" href="https://github.com/winstonford/blueprint/tarball/master">Download this project as a tar.gz file</a>
            </section>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <hr><h2>
<a name="layout-default" class="anchor" href="#layout-default"><span class="octicon octicon-link"></span></a>layout: default</h2>

<h1>
<a name="blueprint" class="anchor" href="#blueprint"><span class="octicon octicon-link"></span></a>Blueprint</h1>

<p>Blueprint is a simple configuration management tool that reverse-engineers servers.  It figures out what you've done manually, stores it locally in a Git repository, generates code that's able to recreate your efforts, and helps you deploy those changes to production.</p>

<h2>
<a name="table-of-contents" class="anchor" href="#table-of-contents"><span class="octicon octicon-link"></span></a>Table of contents</h2>

<ol>
<li> <a href="#philosophy">Philosophy</a>
</li>
<li> <a href="#installation">Installation</a>
</li>
<li> <a href="#create">Reverse-engineering systems with blueprint-create</a>
</li>
<li> <a href="#inspect">Inspecting blueprints</a>
</li>
<li> <a href="#ignore">Ignoring particular resources</a>
</li>
<li> <a href="#rules">Rules files and blueprint-rules</a>
</li>
<li> <a href="#diff-split-prune">Diffing, splitting and pruning existing blueprints</a>
</li>
<li> <a href="#templates">Rendering templates of configuration files</a>
</li>
<li><a href="#services">Controlling service restart conditions</a></li>
<li><a href="#sh">Generating POSIX shell scripts</a></li>
<li><a href="#push-pull">Sharing and distributing blueprints</a></li>
<li><a href="#puppet-chef">Generating Puppet modules and Chef cookbooks</a></li>
<li><a href="#cloudformation">Integrating with AWS CloudFormation</a></li>
<li><a href="#deploy">Deploying your application with Blueprint</a></li>
<li><a href="#git">Local Git repository</a></li>
<li><a href="#server">Running your own Blueprint Server</a></li>
<li><a href="#protocols">Blueprint Server Protocols</a></li>
<li><a href="#endpoints">Blueprint Server Endpoints</a></li>
<li><a href="#contributing">Contributing to Blueprint</a></li>
<li><a href="#alternatives">Alternatives to Blueprint</a></li>
</ol><h2>
<a name="manuals" class="anchor" href="#manuals"><span class="octicon octicon-link"></span></a>Manuals</h2>

<ul>
<li>
<a href="http://devstructure.github.com/blueprint/blueprint-list.1.html"><code>blueprint-list</code>(1)</a>: list all blueprints.</li>
<li>
<a href="http://devstructure.github.com/blueprint/blueprint-create.1.html"><code>blueprint-create</code>(1)</a>: create a blueprint.</li>
<li>
<a href="http://devstructure.github.com/blueprint/blueprint-rules.1.html"><code>blueprint-rules</code>(1)</a>: create a blueprint from a blueprint-rules file.</li>
<li>
<a href="http://devstructure.github.com/blueprint/blueprint-show.1.html"><code>blueprint-show</code>(1)</a>: generate code from a blueprint.</li>
<li>
<a href="http://devstructure.github.com/blueprint/blueprint-diff.1.html"><code>blueprint-diff</code>(1)</a>: save the difference between two blueprints.</li>
<li>
<a href="http://devstructure.github.com/blueprint/blueprint-split.1.html"><code>blueprint-split</code>(1)</a>: split one blueprint into two others interactively.</li>
<li>
<a href="http://devstructure.github.com/blueprint/blueprint-prune.1.html"><code>blueprint-prune</code>(1)</a>: select a subset of resources interactively.</li>
<li>
<a href="http://devstructure.github.com/blueprint/blueprint-template.1.html"><code>blueprint-template</code>(1)</a>: render mustache.sh templates locally.</li>
<li>
<a href="http://devstructure.github.com/blueprint/blueprint-apply.1.html"><code>blueprint-apply</code>(1)</a>: run a blueprint's generated shell code.</li>
<li>
<a href="http://devstructure.github.com/blueprint/blueprint-push.1.html"><code>blueprint-push</code>(1)</a>: push a blueprint to the Internet.</li>
<li>
<a href="http://devstructure.github.com/blueprint/blueprint-pull.1.html"><code>blueprint-pull</code>(1)</a>: pull a blueprint from the Internet.</li>
<li>
<a href="http://devstructure.github.com/blueprint/blueprint-destroy.1.html"><code>blueprint-destroy</code>(1)</a>: destroy a blueprint.</li>
<li>
<a href="http://devstructure.github.com/blueprint/blueprint.5.html"><code>blueprint</code>(5)</a>: Blueprint JSON format.</li>
<li>
<a href="http://devstructure.github.com/blueprint/blueprintignore.5.html"><code>blueprintignore</code>(5)</a>: ignore specific files when creating blueprints.</li>
<li>
<a href="http://devstructure.github.com/blueprint/blueprint-rules.5.html"><code>blueprint-rules</code>(5)</a>: enumerate resources in blueprints.</li>
<li>
<a href="http://devstructure.github.com/blueprint/blueprint.cfg.5.html"><code>blueprint.cfg</code>(5)</a>: centralized blueprint service configuration.</li>
<li>
<a href="http://devstructure.github.com/blueprint/blueprint-template.5.html"><code>blueprint-template</code>(5)</a>: <code>mustache.sh</code> template language syntax.</li>
<li>
<a href="http://devstructure.github.com/blueprint/blueprint-template.7.html"><code>blueprint-template</code>(7)</a>: built-in template data.</li>
<li>
<a href="http://devstructure.github.com/blueprint/blueprint.7.html"><code>blueprint</code>(7)</a>: Blueprint Python library.</li>
</ul><h3>
<a name="plumbing" class="anchor" href="#plumbing"><span class="octicon octicon-link"></span></a>Plumbing</h3>

<ul>
<li>
<a href="http://devstructure.github.com/blueprint/blueprint-git.1.html"><code>blueprint-git</code>(1)</a>: low-level access to blueprints.</li>
<li>
<a href="http://devstructure.github.com/blueprint/blueprint-show-files.1.html"><code>blueprint-show-files</code>(1)</a>: show files in a blueprint.</li>
<li>
<a href="http://devstructure.github.com/blueprint/blueprint-show-ignore.1.html"><code>blueprint-show-ignore</code>(1)</a>: show <code>blueprintignore</code>(5) rules from a blueprint.</li>
<li>
<a href="http://devstructure.github.com/blueprint/blueprint-show-packages.1.html"><code>blueprint-show-packages</code>(1)</a>: show packages in a blueprint.</li>
<li>
<a href="http://devstructure.github.com/blueprint/blueprint-show-services.1.html"><code>blueprint-show-services</code>(1)</a>: show services in a blueprint.</li>
<li>
<a href="http://devstructure.github.com/blueprint/blueprint-show-sources.1.html"><code>blueprint-show-sources</code>(1)</a>: show source tarballs in a blueprint.</li>
</ul><h2>
<a name="apis" class="anchor" href="#apis"><span class="octicon octicon-link"></span></a>APIs</h2>

<ul>
<li><a href="#protocols">Blueprint Server Protocols</a></li>
<li><a href="#endpoints">Blueprint Server Endpoints</a></li>
</ul><hr><h1>
<a name="philosophy" class="anchor" href="#philosophy"><span class="octicon octicon-link"></span></a>Philosophy</h1>

<p>Blueprint was born out of frustration with development environments, deployment processes, and the complexity of configuration management systems.</p>

<p>Blueprint insists development environments realistically model production and that starts with using Linux.  Blueprint only works on Debian- or Red Hat-based Linux systems.  We recommend VirtualBox, Vagrant, Rackspace Cloud, or AWS EC2 for development systems that use the same operating system (and version) as is used in production.</p>

<p>On top of the operating system, we recommend using the same web servers, databases, message queue brokers, and other software in development and production.  This brings development visibility to entire classes of bugs that only occur due to interactions between production components.</p>

<p>When development and production share the same operating system and software stack, they also share the same interactive management tools, meaning developers and operators alike don't need to maintain two vocabularies.  Well-understood tools like <code>apt-get</code>/<code>dpkg</code>, <code>yum</code>/<code>rpm</code>, and the whole collection of Linux system tools are available everywhere.  Blueprint is unique relative to other configuration management in encouraging use of these tools.</p>

<p>What's common to all configuration management tools is the desire to manage the whole stack: from the operating system packages and services through language-specific packages, all the way to your applications.  We need to span all of these across all our systems.  To pick on RubyGems arbitrarily: RubyGems is purposely ignorant of its relationship to the underlying system, favoring compatibility with Windows and a wide variety of UNIX-like operating systems.  Blueprint understands the macro-dependencies between RubyGems itself and the underlying system and is able to predictably reinstall a selection of gems on top of a properly configured operating system.</p>

<p>When constructing this predictable order-of-operations used to reinstall files, packages, services, and source installations, Blueprint, along with other configuration management tools, takes great care in performing idempotent actions.  Thus Blueprint prefers to manage the entire contents of a file rather than a diff or a line to append.  Idempotency means you can apply a blueprint over and over again with confidence that nothing will change if nothing needs to change.</p>

<p>Because Blueprint can reverse-engineer systems, it is of particular use migrating legacy systems into configuration management.  It doesn't matter when you install Blueprint: changes made to the system even before Blueprint is installed will be taken into account.</p>

<hr><h1>
<a name="installation" class="anchor" href="#installation"><span class="octicon octicon-link"></span></a>Installation</h1>

<p>Prerequisites:</p>

<ul>
<li>Debian- or RPM-based Linux</li>
<li>Python &gt;= 2.6</li>
<li>Git &gt;= 1.7 (not just for installation from source)</li>
</ul><h2>
<a name="from-devstructures-debian-archive" class="anchor" href="#from-devstructures-debian-archive"><span class="octicon octicon-link"></span></a>From DevStructure's Debian archive</h2>

<pre><code>echo "deb http://packages.devstructure.com $(lsb_release -sc) main" | sudo tee /etc/apt/sources.list.d/devstructure.list
sudo wget -O /etc/apt/trusted.gpg.d/devstructure.gpg http://packages.devstructure.com/keyring.gpg
sudo apt-get update
sudo apt-get -y install blueprint
</code></pre>

<h2>
<a name="from-pypi" class="anchor" href="#from-pypi"><span class="octicon octicon-link"></span></a>From PyPI</h2>

<pre><code>pip install blueprint
</code></pre>

<p>Make sure <code>pip</code> is using Python &gt;= 2.6, otherwise the installation will succeed but Blueprint will not run.</p>

<h2>
<a name="from-source-on-debian-ubuntu-fedora-centos-6-and-rhel-6" class="anchor" href="#from-source-on-debian-ubuntu-fedora-centos-6-and-rhel-6"><span class="octicon octicon-link"></span></a>From source on Debian, Ubuntu, Fedora, CentOS 6, and RHEL 6</h2>

<pre><code>git clone git://github.com/devstructure/blueprint.git
cd blueprint
git submodule update --init
make &amp;&amp; sudo make install
</code></pre>

<h2>
<a name="from-source-on-centos-5-and-rhel-5" class="anchor" href="#from-source-on-centos-5-and-rhel-5"><span class="octicon octicon-link"></span></a>From source on CentOS 5 and RHEL 5</h2>

<pre><code>rpm -Uvh http://download.fedora.redhat.com/pub/epel/5/i386/epel-release-5-4.noarch.rpm
yum install python26
git clone git://github.com/devstructure/blueprint.git
cd blueprint
git submodule update --init
make &amp;&amp; sudo make install PYTHON=/usr/bin/python26
</code></pre>

<p>This installs Python 2.6 from EPEL side-by-side with Python 2.4 and so won't break Yum.</p>

<hr><h1>
<a name="reverse-engineering-systems-with-blueprint-create" class="anchor" href="#reverse-engineering-systems-with-blueprint-create"><span class="octicon octicon-link"></span></a>Reverse-engineering systems with blueprint-create</h1>

<p>By now you've hopefully created a development environment running the same operating system (and version) that you use in production and installed your production stack.  If this is your first time configuring production databases and web servers, don't be shy about copying-and-pasting from the guy at the next desk or a staging or production system (perhaps even multiple systems).</p>

<p>Once Blueprint itself is installed you can reverse-engineer your development system with a single command.</p>

<pre><code>blueprint create <em>name</em></code></pre>

<p>Blueprint will list packages managed by APT, Yum, RubyGems, Python's <code>easy_install</code> and <code>pip</code>, PHP's PEAR and PECL, and Node.js' NPM.  It will also determine which configuration files in <code>/etc</code> have been added or modified from their packaged versions and collect files in <code>/usr/local</code> that are part of any software packages installed from source (typically via GNU <code>make</code>(1)).  Finally, it will build a list of conditions under which System V init or Upstart services should be restarted, including package upgrades and configuration changes.</p>

<p>All of this information is encoded in a <code>blueprint</code>(5) JSON document and zero or more <code>tar</code>(5) archives and stored in a branch called <em>name</em> in the local Git repository <code>~/.blueprints.git</code>.</p>

<p>Any blueprint in the local Git repository may be applied to the system with <code>blueprint-apply</code>(1):</p>

<pre><code>blueprint apply <em>name</em></code></pre>

<h2>
<a name="example" class="anchor" href="#example"><span class="octicon octicon-link"></span></a>Example</h2>

<p>Suppose you want to install a basic Ruby stack for running a Sinatra application called <code>example</code> proxied by Nginx on Debian-based Linux.  Install the prerequisite packages:</p>

<pre><code>sudo apt-get install build-essential nginx-light ruby ruby-dev rubygems
sudo gem install sinatra unicorn
</code></pre>

<p>Configure Nginx in <code>/etc/nginx/sites-available/example</code>:</p>

<pre><code>server {
    listen 80 default;
    location /static { root /usr/local/share/rack/example/static; }
    location / { proxy_pass http://127.0.0.1:8080; }
}
</code></pre>

<p>Enable the Nginx configuration:</p>

<pre><code>ln -s /etc/nginx/sites-{available,enabled}/example
</code></pre>

<p>Create the application itself.  <code>/usr/local/share/rack/example/app.rb</code>:</p>

<pre><code>require 'sinatra'
get '/hi' do
  "Hello, world!\n"
end
</code></pre>

<p><code>/usr/local/share/rack/example/config.ru</code>:</p>

<pre><code>require 'app'
run Sinatra::Application
</code></pre>

<p>Configure Unicorn in <code>/etc/unicorn.conf.rb</code>:</p>

<pre><code>worker_processes 4
</code></pre>

<p>Configure Upstart to run the application:</p>

<pre><code>description "Example"
start on runlevel [2345]
stop on runlevel [!2345]
respawn
chdir /usr/local/share/rack/example
exec unicorn -c /etc/unicorn.conf.rb
</code></pre>

<p>Now create a blueprint and call it <em>example</em>.</p>

<pre><code>sudo blueprint create example
</code></pre>

<p>We'll pick this example up in the next chapter.</p>

<hr><h1>
<a name="inspecting-blueprints" class="anchor" href="#inspecting-blueprints"><span class="octicon octicon-link"></span></a>Inspecting blueprints</h1>

<p>Once a blueprint has been created and stored in the local Git repository, it's easy to inspect what's been included both in its raw JSON form and in more friendly formats.</p>

<p>First, print the entire <code>blueprint</code>(5) JSON document:</p>

<pre><code>blueprint show <em>name</em> | less</code></pre>

<p>The output of <code>blueprint-show</code>(1) can be a bit overwhelming, which is one of the reasons the following four commands were created.</p>

<p><code>blueprint-show-files</code>(1) lists the pathname of each file included in the blueprint on its own line.</p>

<pre><code><em>pathname</em></code></pre>

<p><code>blueprint-show-packages</code>(1) lists the manager ("<code>apt</code>", "<code>yum</code>", "<code>rubygems1.8</code>", etc.), name, and version number for each package included in the blueprint on its own line.  If two versions of the same package are included (as is possibly with RubyGems and some other package managers), each will be printed on its own line.</p>

<pre><code><em>manager</em> <em>package</em> <em>version</em></code></pre>

<p><code>blueprint-show-services</code>(1) lists the manager ("<code>sysvinit</code>" or "<code>upstart</code>") and name of each service included in the blueprint on its own line.</p>

<pre><code><em>manager</em> <em>service</em></code></pre>

<p><code>blueprint-show-sources</code>(1) lists the source installations included in the blueprint.  The root directory (for example, "<code>/usr/local</code>") and tarball filename are printed to standard error and the contents of the tarball are printed to standard output via <code>tar</code>(1)'s <code>tv</code> options.</p>

<pre><code><em>dirname</em> <em>filename</em><br><em>`tar tv` output</em></code></pre>

<h2>
<a name="example-1" class="anchor" href="#example-1"><span class="octicon octicon-link"></span></a>Example</h2>

<p><code>blueprint show-files example</code></p>

<pre><code>/etc/apt/sources.list
/etc/hosts
/etc/init/example.conf
/etc/mysql/debian.cnf
/etc/nginx/sites-available/example
/etc/nginx/sites-enabled/default
/etc/nginx/sites-enabled/example
/etc/unicorn.conf.rb
</code></pre>

<p><code>blueprint show-packages example</code></p>

<pre><code>apt binutils 2.21.53.20110810-0ubuntu3
apt blueprint 3.4.0-1py2.7
apt build-essential 11.5ubuntu1
apt ca-certificates 20110502+nmu1ubuntu5
apt cpp 4:4.6.1-2ubuntu5
apt cpp-4.6 4.6.1-9ubuntu3
apt curl 7.21.6-3ubuntu3
apt dpkg-dev 1.16.0.3ubuntu5
apt fakeroot 1.17-1
apt g++ 4:4.6.1-2ubuntu5
apt g++-4.6 4.6.1-9ubuntu3
apt gcc 4:4.6.1-2ubuntu5
apt gcc-4.6 4.6.1-9ubuntu3
apt git 1:1.7.5.4-1
apt git-core 1:1.7.5.4-1
apt git-man 1:1.7.5.4-1
apt libalgorithm-diff-perl 1.19.02-2
apt libalgorithm-diff-xs-perl 0.04-1build1
apt libalgorithm-merge-perl 0.08-2
apt libc-dev-bin 2.13-20ubuntu5
apt libc6-dev 2.13-20ubuntu5
apt libcurl3 7.21.6-3ubuntu3
apt libcurl3-gnutls 7.21.6-3ubuntu3
apt libdbd-mysql-perl 4.019-1
apt libdbi-perl 1.616-1build1
apt libdpkg-perl 1.16.0.3ubuntu5
apt liberror-perl 0.17-1
apt libgmp10 2:5.0.1+dfsg-7ubuntu2
apt libgomp1 4.6.1-9ubuntu3
apt libhtml-template-perl 2.10-1
apt libmpc2 0.9-3
apt libmpfr4 3.0.1-5
apt libmysqlclient16 5.1.58-1ubuntu1
apt libnet-daemon-perl 0.48-1
apt libplrpc-perl 0.2020-2
apt libquadmath0 4.6.1-9ubuntu3
apt libreadline5 5.2-9ubuntu1
apt librtmp0 2.3-2ubuntu1
apt libruby1.8 1.8.7.352-2
apt libstdc++6-4.6-dev 4.6.1-9ubuntu3
apt libtimedate-perl 1.2000-1
apt libwrap0 7.6.q-21
apt linux-libc-dev 3.0.0-12.20
apt manpages-dev 3.27-1ubuntu2
apt mysql-client-5.1 5.1.58-1ubuntu1
apt mysql-client-core-5.1 5.1.58-1ubuntu1
apt mysql-common 5.1.58-1ubuntu1
apt mysql-server 5.1.58-1ubuntu1
apt mysql-server-5.1 5.1.58-1ubuntu1
apt mysql-server-core-5.1 5.1.58-1ubuntu1
apt nginx-common 1.0.5-1
apt nginx-light 1.0.5-1
apt openssh-server 1:5.8p1-7ubuntu1
apt openssl 1.0.0e-2ubuntu4
apt python-pip 1.0-1
apt python-pkg-resources 0.6.16-1
apt python-setuptools 0.6.16-1
apt rsync 3.0.8-1ubuntu1
apt ruby 4.8
apt ruby-dev 4.8
apt ruby1.8 1.8.7.352-2
apt ruby1.8-dev 1.8.7.352-2
apt rubygems 1.7.2-1
apt tmux 1.5-1
python-pip Django 1.3.1
rubygems fpm 0.3.11
rubygems hpricot 0.8.5
rubygems json 1.6.3
rubygems kgio 2.6.0
rubygems mustache 0.99.4
rubygems rack 1.3.5
rubygems rack-protection 1.1.4
rubygems raindrops 0.8.0
rubygems rdiscount 1.6.8
rubygems sinatra 1.3.1
rubygems tilt 1.3.3
rubygems unicorn 4.1.1
</code></pre>

<p><code>blueprint show-services example</code></p>

<pre><code>sysvinit nginx
sysvinit ssh
upstart example
upstart mysql
</code></pre>

<p><code>blueprint show-sources example</code></p>

<pre><code>/usr/local 82789250f3ad94d4cfeacc0a8cabae2d26b0270e.tar
drwxr-xr-x root/root         0 2011-11-29 21:42 ./
drwxr-xr-x root/root         0 2011-11-29 20:50 ./share/
drwxr-xr-x root/root         0 2011-11-29 21:55 ./share/rack/
drwxr-xr-x rcrowley/rcrowley 0 2011-12-09 15:12 ./share/rack/example/
-rw-rw-r-- rcrowley/rcrowley 55 2011-11-29 21:02 ./share/rack/example/app.rb
-rw-rw-r-- rcrowley/rcrowley 39 2011-11-29 20:54 ./share/rack/example/config.ru
</code></pre>

<p>We're off to a great start but there are some extraneous files and packages here that need cleaning up.</p>

<hr><h1>
<a name="ignoring-particular-resources" class="anchor" href="#ignoring-particular-resources"><span class="octicon octicon-link"></span></a>Ignoring particular resources</h1>

<p>Rather than requiring you enumerate every detail of your infrastructure in code, Blueprint reverse-engineers most of these details from running systems.  There are times, though, when it's a bit too verbose.</p>

<p>Inspired by similar features in version control software, Blueprint allows you to enumerate files, packages, services, and sources that should be ignored in a file format inspired by <code>gitignore</code>(5).  See <code>blueprintignore</code>(5) for details.</p>

<p>Blueprint looks for these rules in <code>/etc/blueprintignore</code> and <code>~/.blueprintignore</code>.  Rules in <code>/etc/blueprintignore</code> will be included in the blueprint itself, thereby propagating to other users of the blueprint.  Rules in <code>~/.blueprintignore</code> will remain local though each revision of a blueprint will store the full set of rules used to create it.</p>

<p>Files may be specified by fully-qualified or relative pathnames, possibly including glob syntax:</p>

<pre><code>/etc/foo
foo/*
*.foo
[abc]/[xyz]
</code></pre>

<p>Packages must be specified by their manager and name, prefixed with <code>:package:</code>:</p>

<pre><code>:package:apt/build-essential
</code></pre>

<p>When a package is ignored, packages on which it depends are also ignored.</p>

<p>Services must be specified by their manager and name, prefixed with <code>:service:</code>:</p>

<pre><code>:service:sysvinit/ssh
</code></pre>

<p>Sources must be specified by fully-qualified pathnames:</p>

<pre><code>:sources:/usr/local
</code></pre>

<p>You can ignore and unignore particular files within a source directory to fine-tune what's included in the tarball.</p>

<p>Any rule may be negated by prefixing it with a <code>!</code>, which overrides defaults and well as previous matching rules - the last matching rule wins.</p>

<h2>
<a name="example-2" class="anchor" href="#example-2"><span class="octicon octicon-link"></span></a>Example</h2>

<p><code>/etc/apt/sources.list</code> and <code>/etc/hosts</code> really don't belong in the blueprint since they're part of the operating system and we haven't customized them.  Add their pathnames to <code>/etc/blueprintignore</code>:</p>

<pre><code>/etc/apt/sources.list
/etc/hosts
</code></pre>

<p><code>/etc/mysql/debian.cnf</code> is generated by the MySQL server package in its <code>postinst</code> maintainer script.  Add its pathname to <code>/etc/blueprintignore</code>:</p>

<pre><code>/etc/mysql/debian.cnf
</code></pre>

<p><code>/etc/nginx/sites-enabled/default</code> is part of the basic Nginx installation and again we don't particularly care about it.  Add its pathname to <code>/etc/blueprintignore</code>:</p>

<pre><code>/etc/nginx/sites-enabled/default
</code></pre>

<p><code>build-essential</code> brought a lot of friends along that are clouding what's really important in this blueprint.  Recall that ignoring a package also ignores its dependencies.  The opposite is not true: unignoring a package leaves its dependencies alone.  Ignoring and immediately unignoring <code>build-essential</code>, <code>ruby</code>, and <code>ruby-dev</code> will slim down the blueprint without any loss in completeness.</p>

<pre><code>:package:apt/build-essential
!:package:apt/build-essential
:package:apt/ruby
!:package:apt/ruby
:package:apt/ruby-dev
!:package:apt/ruby-dev
</code></pre>

<p>Running <code>sudo blueprint create example</code> again will commit a new blueprint that takes these rules into account.</p>

<hr><h1>
<a name="rules-files-and-blueprint-rules" class="anchor" href="#rules-files-and-blueprint-rules"><span class="octicon octicon-link"></span></a>Rules files and blueprint-rules</h1>

<p>As complexity grows, you're likely to pass an inflection point when it becomes easier to enumerate the resources you care about, not the resources that should be ignored.  When the time comes, Blueprint is ready.  The rules syntax used to ignore particular resources can be turned around and used to enumerate the resources to include in the blueprint.  See <code>blueprint-rules</code>(5) for details.</p>

<p>The <code>blueprint-rules</code>(1) command reverse-engineers the system just like <code>blueprint-create</code> but limits the resources included in the blueprint to those in the rules file.</p>

<pre><code>blueprint rules <em>pathname</em></code></pre>

<p>The rules files are a bit of a hybrid between the traditional Blueprint approach of reverse-engineering and the typical configuration-as-code approach of other configuration management tools.</p>

<h2>
<a name="example-3" class="anchor" href="#example-3"><span class="octicon octicon-link"></span></a>Example</h2>

<p>Add these rules to <code>example.blueprint-rules</code>:</p>

<pre><code>:source:/usr/local
/etc/init/example.conf
/etc/nginx/sites-*/example
:package:apt/libmysqlclient-dev
:package:apt/mysql-client-5.1
:package:apt/nginx-common
:package:apt/nginx-light
:package:apt/ruby-dev
:package:apt/rubygems
:package:rubygems/*
:service:sysvinit/nginx
:service:upstart/example
</code></pre>

<p>Now create the blueprint <code>example</code>:</p>

<pre><code>blueprint rules example.blueprint-rules
</code></pre>

<p>As usual, the blueprint is stored locally in Git, ready for action.</p>

<p>A good exercise for the reader is creation of a separate blueprint for the MySQL server and its configuration.  It's installed alongside the web stack in development but that's unlikely to be the case in production, so having two blueprints could be advantageous.  The next chapter introduces another way to create two blueprints from one system.</p>

<hr><h1>
<a name="diffing-splitting-and-pruning-existing-blueprints" class="anchor" href="#diffing-splitting-and-pruning-existing-blueprints"><span class="octicon octicon-link"></span></a>Diffing, splitting and pruning existing blueprints</h1>

<p>Refactoring is a major part of software development practice and configuration management shouldn't be left out in the cold.  Blueprint provides several tools that can be used to refactor your blueprints into more modular, maintainable, focused artifacts.</p>

<p><code>blueprint-diff</code>(1) takes direct advantage of the subtraction operator available on <code>Blueprint</code> objects in the underlying library.</p>

<pre><code>blueprint diff <em>minuend</em> <em>subtrahend</em> <em>difference</em></code></pre>

<p>Resources that appear in <em>minuend</em> but not <em>subtrahend</em> will be included in <em>difference</em> and committed to the local Git repository under that name.</p>

<p><code>blueprint-split</code>(1) and <code>blueprint-prune</code>(1) are interactive refactoring tools.</p>

<p><code>blueprint-split</code> prints each resource in <em>src</em> and prompts you for a choice of <em>dest-a</em> or <em>dest-b</em>.  The resulting <em>dest-a</em> and <em>dest-b</em> blueprints are committed to the local Git repository.</p>

<pre><code>blueprint split <em>src</em> <em>dest-a</em> <em>dest-b</em></code></pre>

<p><code>blueprint-prune</code> instead prompts you to include or ignore each resource in <em>src</em> in <em>dest</em>.</p>

<pre><code>blueprint prune <em>src</em> <em>dest</em></code></pre>

<p>There are some limitations in both of these tools, however.  You can't currently split the files within a source tarball.  The best workaround is to use rules files to create blueprints that contain only the files you want.</p>

<h2>
<a name="example-4" class="anchor" href="#example-4"><span class="octicon octicon-link"></span></a>Example</h2>

<p><code>blueprint prune example example-nginx</code></p>

<pre><code>/usr/local 6326b42413443bc2d94e13747d05f650b873a53e.tar
Include in blueprint example-nginx? [y/n] n
/etc/init/example.conf
Include in blueprint example-nginx? [y/n] n
/etc/nginx/sites-available/example
Include in blueprint example-nginx? [y/n] y
/etc/nginx/sites-enabled/example
Include in blueprint example-nginx? [y/n] y
apt nginx-common 1.0.5-1
Include in blueprint example-nginx? [y/n] y
apt nginx-light 1.0.5-1
Include in blueprint example-nginx? [y/n] y
apt ruby-dev 4.8
Include in blueprint example-nginx? [y/n] n
apt rubygems 1.7.2-1
Include in blueprint example-nginx? [y/n] n
rubygems fpm 0.3.11
Include in blueprint example-nginx? [y/n] n
rubygems hpricot 0.8.5
Include in blueprint example-nginx? [y/n] n
rubygems json 1.6.3
Include in blueprint example-nginx? [y/n] n
rubygems kgio 2.6.0
Include in blueprint example-nginx? [y/n] n
rubygems mustache 0.99.4
Include in blueprint example-nginx? [y/n] n
rubygems rack 1.3.5
Include in blueprint example-nginx? [y/n] n
rubygems rack-protection 1.1.4
Include in blueprint example-nginx? [y/n] n
rubygems raindrops 0.8.0
Include in blueprint example-nginx? [y/n] n
rubygems rdiscount 1.6.8
Include in blueprint example-nginx? [y/n] n
rubygems sinatra 1.3.1
Include in blueprint example-nginx? [y/n] n
rubygems tilt 1.3.3
Include in blueprint example-nginx? [y/n] n
rubygems unicorn 4.1.1
Include in blueprint example-nginx? [y/n] n
sysvinit nginx
Include in blueprint example-nginx? [y/n] y
upstart example
Include in blueprint example-nginx? [y/n] n
</code></pre>

<p>The same could have been done with <code>blueprint-split</code> to create <code>example-nginx</code> and <code>example-mysql</code> or <code>base</code> and <code>custom</code> — any distinction you desire.</p>

<hr><h1>
<a name="rendering-templates-of-configuration-files" class="anchor" href="#rendering-templates-of-configuration-files"><span class="octicon octicon-link"></span></a>Rendering templates of configuration files</h1>

<p>Not all systems are created equal.  Certainly your <code>m2.4xlarge</code> AWS EC2 instance packs a bit more CPU than a virtual machine running in a corner of your laptop and your configurations should be able to cope with these operational extremes.</p>

<p>Blueprint allows configuration files (found in <code>/etc</code>) to be specified as templates and (optionally) data rather than static content.  These templates are rendered by a special portable dialect of the <code>mustache</code>(5) template language called <code>mustache.sh</code>.  See <code>blueprint-template</code>(5) for details.</p>

<p>In their simplest form, these templates allow substitution of system parameters.</p>

<pre><code>{{<em>FOO</em>}}</code></pre>

<p>You can also substitute the output of a shell command.</p>

<pre><code>{{`<em>echo foo</em>`}}</code></pre>

<p>More complex uses can iterate over the lines of output from a shell command.</p>

<pre><code>{{#`<em>echo foo; echo bar; echo baz</em>`}}<br>{{_M_LINE}}<br>{{/`<em>echo foo; echo bar; echo baz</em>`}}</code></pre>

<p>Blueprint ships with a small helping of common system parameters:</p>

<ul>
<li>
<code>CORES</code>: the number of CPU cores in the system.</li>
<li>
<code>MEM</code>: the total amount of memory in the system in bytes.</li>
<li>
<code>FQDN</code>: the fully-qualified domain name according to <code>hostname</code>(1)'s <code>--fqdn</code> option.</li>
<li>
<code>PRIVATE_IP</code>: the first private IPv4 address assigned to any interface.</li>
<li>
<code>PUBLIC_IP</code>: the first public IPv4 address assigned to any interface.</li>
</ul><p>There are several more, documented in <code>blueprint-template</code>(7).  You can provide your own global data by adding <code>source</code>-able shell scripts with the <code>.sh</code> suffix to <code>/etc/blueprint-template.d</code>.</p>

<p>Any <em>pathname</em> may have an associated template, <code><em>pathname</em>.blueprint-template.mustache</code>.  An additional <code>source</code>-able shell script private to just this template may be placed in <code><em>pathname</em>.blueprint-template.sh</code>.</p>

<p>To render a template locally (likely during development), use <code>blueprint-template(1)</code>.</p>

<pre><code>blueprint template <em>pathname</em></code></pre>

<h2>
<a name="example-5" class="anchor" href="#example-5"><span class="octicon octicon-link"></span></a>Example</h2>

<p>Our Unicorn configuration statically assumes four workers is the best configuration.  In reality, Unicorn workers are a function of the number of CPU cores available.</p>

<p>Configure Unicorn to use one worker per CPU in <code>/etc/unicorn.conf.rb.blueprint-template.mustache</code>:</p>

<pre><code>worker_processes {{CORES}}</code></pre>

<p>Configure Unicorn to use four workers per CPU in <code>/etc/unicorn.conf.rb.blueprint-template.mustache</code>:</p>

<pre><code>worker_processes {{`expr 4 \* $CORES`}}</code></pre>

<p>Or, you can extract computation out of the template and into <code>/etc/unicorn.conf.rb.blueprint-template.sh</code>:</p>

<pre><code>export WORKER_PROCESSES="$(expr 4 \* $CORES)"
</code></pre>

<p><code>/etc/unicorn.conf.rb.blueprint-template.mustache</code> becomes:</p>

<pre><code>worker_processes {{WORKER_PROCESSES}}</code></pre>

<p>Now Blueprint can scale this Unicorn configuration up and down as the system allows or requires.</p>

<hr><h1>
<a name="controlling-service-restart-conditions" class="anchor" href="#controlling-service-restart-conditions"><span class="octicon octicon-link"></span></a>Controlling service restart conditions</h1>

<p>The last step in applying a blueprint is to restart all the services whose configuration changed.  Most configuration management tools require you to connect the dots explicitly but Blueprint finds many of those relationships automatically.</p>

<p>System V init and Upstart services are included in blueprints when their init script or configuration file, or the package that contains the init script or configuration file, are included in the blueprint.  From there, Blueprint searches for resources that, when changed, should cause the service to restart.</p>

<ul>
<li>When the package that contains the service init script or configuration file is upgraded, the service should be restarted.</li>
<li>When other files in the package that contains the service change, the service should be restarted.</li>
<li>When files in directories in the package that contains the service change, the service should be restarted.</li>
<li>When fully-qualified pathnames (be they files or directories) mentioned in the service init script or configuration file are changed, the service should be restarted.  This accounts for both changes to individual files and changes in source tarballs.</li>
</ul><p>Other files may be added to the list to watch by naming them in a comment in the service init script or configuration file.</p>

<h2>
<a name="example-6" class="anchor" href="#example-6"><span class="octicon octicon-link"></span></a>Example</h2>

<p>Suppose our <code>example</code> application reads <code>/etc/database.yml</code> for database connection credentials.  The Unicorn application server must be restarted to read changes to this file.  Mention <code>/etc/database.yml</code> in the Upstart configuration:</p>

<pre><code>description "Example"
start on runlevel [2345]
stop on runlevel [!2345]
respawn
chdir /usr/local/share/rack/example
exec unicorn -c /etc/unicorn.conf.rb
# Dear Blueprint, restart me when /etc/database.yml changes.
</code></pre>

<hr><h1>
<a name="generating-posix-shell-scripts" class="anchor" href="#generating-posix-shell-scripts"><span class="octicon octicon-link"></span></a>Generating POSIX shell scripts</h1>

<p>Beneath the <code>blueprint-apply</code>(1) command briefly introduced before there is the <code>-S</code> option to <code>blueprint-show</code>(1) which generates a POSIX shell script that can apply a blueprint to any system.</p>

<p>Dependencies are especially painful when bootstrapping new systems so Blueprint takes great pains to generate dependency-free shell scripts.  They extract source tarballs, place file contents and adjust owners/groups/modes, install packages, and restart services as necessary according to the algorithm described in <code>blueprint</code>(5).  Even template rendering is handled without any dependencies.</p>

<p>The generated shell script for the blueprint <em>name</em> is written to a file in your working directory as <code><em>name</em>.sh</code> or <code><em>name</em>/bootstrap.sh</code> if the blueprint contains templates or source tarballs.</p>

<pre><code>blueprint show -S <em>name</em></code></pre>

<p>This shell script and its associated files can drive deployment, provisioning, or other development environments without even having to install Blueprint first.</p>

<h2>
<a name="example-7" class="anchor" href="#example-7"><span class="octicon octicon-link"></span></a>Example</h2>

<p>Running <code>blueprint show -S example</code> creates <code>example/bootstrap.sh</code> as follows and bundles <code>mustache.sh</code> and the source tarball containing our example application.  <code>example/bootstrap.sh</code>:</p>

<pre><code>#
# Automatically generated by blueprint(7).  Edit at your own risk.
#

set -x

cd "$(dirname "$0")"

mkdir -p "/etc/init"
cat &gt;"/etc/init/example.conf" &lt;&lt;EOF
description "Example"
start on runlevel [2345]
stop on runlevel [!2345]
respawn
chdir /usr/local/share/rack/example
exec unicorn -c /etc/unicorn.conf.rb
# Dear Blueprint, restart me when /etc/database.yml changes.
EOF
MD5SUM="$(md5sum "/etc/nginx/sites-available/example" 2&gt;/dev/null)"
mkdir -p "/etc/nginx/sites-available"
cat &gt;"/etc/nginx/sites-available/example" &lt;&lt;EOF
server {
listen 80 default;
location /static { root /usr/local/share/rack/example/static; }
location / { proxy_pass http://127.0.0.1:8080; }
}
EOF
[ "$MD5SUM" != "$(md5sum "/etc/nginx/sites-available/example")" ] &amp;&amp; SERVICE_sysvinit_nginx=1
MD5SUM="$(md5sum "/etc/nginx/sites-enabled/example" 2&gt;/dev/null)"
mkdir -p "/etc/nginx/sites-enabled"
ln -s "/etc/nginx/sites-available/example" "/etc/nginx/sites-enabled/example"
[ "$MD5SUM" != "$(md5sum "/etc/nginx/sites-enabled/example")" ] &amp;&amp; SERVICE_sysvinit_nginx=1
MD5SUM="$(md5sum "/etc/unicorn.conf.rb" 2&gt;/dev/null)"
mkdir -p "/etc"
(
set +x
. "lib/mustache.sh"
for F in */blueprint-template.d/*.sh
do
    . "$F"
done
export WORKER_PROCESSES="$(expr 4 \* $CORES)"
mustache &gt;"/etc/unicorn.conf.rb" &lt;&lt;EOF
worker_processes {{WORKER_PROCESSES}}
EOF
)
[ "$MD5SUM" != "$(md5sum "/etc/unicorn.conf.rb")" ] &amp;&amp; SERVICE_upstart_example=1
export APT_LISTBUGS_FRONTEND="none"
export APT_LISTCHANGES_FRONTEND="none"
export DEBIAN_FRONTEND="noninteractive"
apt-get -q update
[ "$(dpkg-query -f'${Version}\n' -W mysql-client-5.1)" = "5.1.58-1ubuntu1" ] || apt-get -y -q -o DPkg::Options::=--force-confold install mysql-client-5.1=5.1.58-1ubuntu1
[ "$(dpkg-query -f'${Version}\n' -W nginx-common)" = "1.0.5-1" ] || { apt-get -y -q -o DPkg::Options::=--force-confold install nginx-common=1.0.5-1; SERVICE_sysvinit_nginx=1; }
[ "$(dpkg-query -f'${Version}\n' -W nginx-light)" = "1.0.5-1" ] || apt-get -y -q -o DPkg::Options::=--force-confold install nginx-light=1.0.5-1
[ "$(dpkg-query -f'${Version}\n' -W ruby-dev)" = "4.8" ] || apt-get -y -q -o DPkg::Options::=--force-confold install ruby-dev=4.8
[ "$(dpkg-query -f'${Version}\n' -W rubygems)" = "1.7.2-1" ] || apt-get -y -q -o DPkg::Options::=--force-confold install rubygems=1.7.2-1
gem -i -v0.3.11 fpm &gt;/dev/null || gem install --no-rdoc --no-ri -v0.3.11 fpm
gem -i -v0.8.5 hpricot &gt;/dev/null || gem install --no-rdoc --no-ri -v0.8.5 hpricot
gem -i -v1.6.3 json &gt;/dev/null || gem install --no-rdoc --no-ri -v1.6.3 json
gem -i -v2.6.0 kgio &gt;/dev/null || gem install --no-rdoc --no-ri -v2.6.0 kgio
gem -i -v0.99.4 mustache &gt;/dev/null || gem install --no-rdoc --no-ri -v0.99.4 mustache
gem -i -v1.3.5 rack &gt;/dev/null || gem install --no-rdoc --no-ri -v1.3.5 rack
gem -i -v1.1.4 rack-protection &gt;/dev/null || gem install --no-rdoc --no-ri -v1.1.4 rack-protection
gem -i -v0.8.0 raindrops &gt;/dev/null || gem install --no-rdoc --no-ri -v0.8.0 raindrops
gem -i -v1.6.8 rdiscount &gt;/dev/null || gem install --no-rdoc --no-ri -v1.6.8 rdiscount
gem -i -v1.3.1 sinatra &gt;/dev/null || gem install --no-rdoc --no-ri -v1.3.1 sinatra
gem -i -v1.3.3 tilt &gt;/dev/null || gem install --no-rdoc --no-ri -v1.3.3 tilt
gem -i -v4.1.1 unicorn &gt;/dev/null || gem install --no-rdoc --no-ri -v4.1.1 unicorn
[ -n "$SERVICE_sysvinit_nginx" ] &amp;&amp; /etc/init.d/nginx restart
[ -n "$SERVICE_upstart_example" ] &amp;&amp; { restart example || start example; }</code></pre>

<hr><h1>
<a name="sharing-and-distributing-blueprints" class="anchor" href="#sharing-and-distributing-blueprints"><span class="octicon octicon-link"></span></a>Sharing and distributing blueprints</h1>

<p><strong>DevStructure runs a free Blueprint Server at <code>devstructure.com</code> but this service will not be available after June 30<sup>th</sup>, 2012.</strong>  Learn more about <a href="#server">running your own Blueprint Server</a></p>

<p>We at DevStructure saw the workflow unfolding around these generated shell scripts and in them an opportunity for a macro don't-repeat-yourself optimization.  Thus were born <code>blueprint-push</code>(1) and <code>blueprint-pull</code>(1).</p>

<p>If you decide to <a href="#server">run your own Blueprint Server</a>, you'll need to configure a <code>server</code> ahead of time in <code>/etc/blueprint.cfg</code>:</p>

<pre><code>[io]
server = <em>server</em></code></pre>

<p><code>blueprint-push</code> uploads the JSON document and all source tarballs referenced by a blueprint to a Blueprint Server, which stores them behind a long secret key in AWS S3.  The URL that may be used to pull the blueprint later is printed to standard output.</p>

<pre><code>blueprint push <em>name</em></code></pre>

<p>The first time you run this command it will prompt you with the contents of <code>/etc/blueprint.cfg</code> which you can optionally put in place.  If you do, Blueprint will reuse the same secret the next time <code>blueprint-push</code> is called.  Configuring a secret this way allows you to push revisions to your blueprints which can then be pulled from a known location.</p>

<p><code>blueprint-pull</code> downloads the JSON document and all source tarballs referenced by a blueprint that has been pushed and stores them in the local Git repository.  Typically, it accepts the URL printed by <code>blueprint-push</code> but if you configure a default secret in <code>/etc/blueprint.cfg</code>, you can pull blueprints by only their name.</p>

<pre><code>blueprint pull <em>url</em></code></pre>

<pre><code>blueprint pull <em>name</em></code></pre>

<p>Just as <code>blueprint-show</code>'s <code>-S</code> option helps bootstrap systems with zero dependencies, <code>devstructure.com</code> can generate shell scripts remotely so Blueprint doesn't have to be installed ahead of time.  You can bootstrap a new system from a pushed blueprint in one command:</p>

<pre><code>curl https://devstructure.com/<em>secret</em>/<em>name</em>/<em>name</em>.sh | sh</code></pre>

<h2>
<a name="example-8" class="anchor" href="#example-8"><span class="octicon octicon-link"></span></a>Example</h2>

<p>Push the <em>example</em> blueprint to <code>devstructure.com</code>:</p>

<pre><code>blueprint push example
</code></pre>

<p>Now configure a production system to apply the latest revision to <em>example</em> every half hour (this behavior should be familiar to Puppet and Chef users).  In <code>root</code>'s crontab:</p>

<pre><code>*/30 * * * * curl https://devstructure.com/0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz_-/example/example.sh | sh
</code></pre>

<hr><h1>
<a name="generating-puppet-modules-and-chef-cookbooks" class="anchor" href="#generating-puppet-modules-and-chef-cookbooks"><span class="octicon octicon-link"></span></a>Generating Puppet modules and Chef cookbooks</h1>

<p>Blueprint can also streamline the development workflow in Puppet- or Chef-managed environments by generating complete Puppet modules or Chef cookbooks.</p>

<p>Generate a Puppet module in <code><em>name</em>/manifests/init.pp</code>:</p>

<pre><code>blueprint show -P <em>name</em></code></pre>

<p>Generate a Chef cookbook in <code><em>name</em>/recipes/default.rb</code>:</p>

<pre><code>blueprint show -C <em>name</em></code></pre>

<p>These modules and cookbooks may be included directly in any Puppet or Chef environment or be used as the starting point for further development — the code is formatted according to the style guidelines of the respective communities.</p>

<p>Note, however, that the file templates used by Blueprint are incompatible with Puppet and Chef and so can't be included in the generated modules and cookbooks.</p>

<h2>
<a name="example-9" class="anchor" href="#example-9"><span class="octicon octicon-link"></span></a>Example</h2>

<p>Running <code>blueprint show -P example</code> creates <code>example/manifests/init.pp</code> as follows and bundles the source tarball containing our example application.  <code>example/manifests/init.pp</code>:</p>

<pre><code>#
# Automatically generated by blueprint(7).  Edit at your own risk.
#
class example {
    Exec {
        path =&gt; '/home/rcrowley/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games',
    }
    Class['sources'] -&gt; Class['files'] -&gt; Class['packages']
    class files {
        file {
            '/etc':
                ensure =&gt; directory;
            '/etc/init':
                ensure =&gt; directory;
            '/etc/init/example.conf':
                content =&gt; template('example/etc/init/example.conf'),
                ensure  =&gt; file,
                group   =&gt; root,
                mode    =&gt; 0644,
                owner   =&gt; root;
            '/etc/nginx':
                ensure =&gt; directory;
            '/etc/nginx/sites-available':
                ensure =&gt; directory;
            '/etc/nginx/sites-available/example':
                content =&gt; template('example/etc/nginx/sites-available/example'),
                ensure  =&gt; file,
                group   =&gt; root,
                mode    =&gt; 0644,
                owner   =&gt; root;
            '/etc/nginx/sites-enabled':
                ensure =&gt; directory;
            '/etc/nginx/sites-enabled/example':
                ensure =&gt; '/etc/nginx/sites-available/example',
                group  =&gt; root,
                owner  =&gt; root;
            '/etc/unicorn.conf.rb':
                content =&gt; template('example/etc/unicorn.conf.rb'),
                ensure  =&gt; file,
                group   =&gt; root,
                mode    =&gt; 0644,
                owner   =&gt; root;
        }
    }
    include files
    class packages {
        Class['apt'] -&gt; Class['rubygems']
        exec { 'apt-get -q update':
            before =&gt; Class['apt'],
        }
        class apt {
            package {
                'mysql-client-5.1':
                    ensure =&gt; '5.1.58-1ubuntu1';
                'nginx-common':
                    ensure =&gt; '1.0.5-1';
                'nginx-light':
                    ensure =&gt; '1.0.5-1';
                'ruby-dev':
                    ensure =&gt; '4.8';
                'rubygems':
                    ensure =&gt; '1.7.2-1';
            }
        }
        include apt
        class rubygems {
            package {
                'fpm':
                    ensure   =&gt; '0.3.11',
                    provider =&gt; gem;
                'hpricot':
                    ensure   =&gt; '0.8.5',
                    provider =&gt; gem;
                'json':
                    ensure   =&gt; '1.6.3',
                    provider =&gt; gem;
                'kgio':
                    ensure   =&gt; '2.6.0',
                    provider =&gt; gem;
                'mustache':
                    ensure   =&gt; '0.99.4',
                    provider =&gt; gem;
                'rack':
                    ensure   =&gt; '1.3.5',
                    provider =&gt; gem;
                'rack-protection':
                    ensure   =&gt; '1.1.4',
                    provider =&gt; gem;
                'raindrops':
                    ensure   =&gt; '0.8.0',
                    provider =&gt; gem;
                'rdiscount':
                    ensure   =&gt; '1.6.8',
                    provider =&gt; gem;
                'sinatra':
                    ensure   =&gt; '1.3.1',
                    provider =&gt; gem;
                'tilt':
                    ensure   =&gt; '1.3.3',
                    provider =&gt; gem;
                'unicorn':
                    ensure   =&gt; '4.1.1',
                    provider =&gt; gem;
            }
        }
        include rubygems
    }
    include packages
    class services {
        class sysvinit {
            service { 'nginx':
                enable    =&gt; true,
                ensure    =&gt; running,
                subscribe =&gt; [File['/etc/nginx/sites-available/example'], File['/etc/nginx/sites-enabled/example'], Package['nginx-common'], Exec['82789250f3ad94d4cfeacc0a8cabae2d26b0270e.tar']],
            }
        }
        include sysvinit
        class upstart {
            service { 'example':
                enable    =&gt; true,
                ensure    =&gt; running,
                provider  =&gt; upstart,
                subscribe =&gt; [File['/etc/unicorn.conf.rb'], Exec['82789250f3ad94d4cfeacc0a8cabae2d26b0270e.tar']],
            }
        }
        include upstart
    }
    include services
    class sources {
        exec { 'tar xf /tmp/82789250f3ad94d4cfeacc0a8cabae2d26b0270e.tar':
            alias =&gt; '/usr/local',
            cwd   =&gt; '/usr/local',
        }
        file { '/tmp/82789250f3ad94d4cfeacc0a8cabae2d26b0270e.tar':
            before =&gt; Exec['/usr/local'],
            group  =&gt; root,
            mode   =&gt; 0644,
            owner  =&gt; root,
            source =&gt; 'puppet:///modules/example/tmp/82789250f3ad94d4cfeacc0a8cabae2d26b0270e.tar',
        }
    }
    include sources
}
</code></pre>

<p>Running <code>blueprint show -C example</code> creates <code>example/recipes/default.rb</code> as follows and bundles the source tarball containing our example application.  <code>example/recipes/default.rb</code>:</p>

<pre><code>#
# Automatically generated by blueprint(7).  Edit at your own risk.
#
cookbook_file('/tmp/82789250f3ad94d4cfeacc0a8cabae2d26b0270e.tar') do
  backup false
  group 'root'
  mode '0644'
  owner 'root'
  source 'tmp/82789250f3ad94d4cfeacc0a8cabae2d26b0270e.tar'
end
execute('tar xf "/tmp/82789250f3ad94d4cfeacc0a8cabae2d26b0270e.tar"') { cwd '/usr/local' }
directory('/etc/init') do
  group 'root'
  mode '0755'
  owner 'root'
  recursive true
end
cookbook_file('/etc/init/example.conf') do
  backup false
  group 'root'
  mode '0644'
  owner 'root'
  source 'etc/init/example.conf'
end
directory('/etc/nginx/sites-available') do
  group 'root'
  mode '0755'
  owner 'root'
  recursive true
end
cookbook_file('/etc/nginx/sites-available/example') do
  backup false
  group 'root'
  mode '0644'
  owner 'root'
  source 'etc/nginx/sites-available/example'
end
directory('/etc/nginx/sites-enabled') do
  group 'root'
  mode '0755'
  owner 'root'
  recursive true
end
link('/etc/nginx/sites-enabled/example') do
  group 'root'
  owner 'root'
  to '/etc/nginx/sites-available/example'
end
directory('/etc') do
  group 'root'
  mode '0755'
  owner 'root'
  recursive true
end
cookbook_file('/etc/unicorn.conf.rb') do
  backup false
  group 'root'
  mode '0644'
  owner 'root'
  source 'etc/unicorn.conf.rb'
end
execute('apt-get -q update')
package('mysql-client-5.1') { version '5.1.58-1ubuntu1' }
package('nginx-common') { version '1.0.5-1' }
package('nginx-light') { version '1.0.5-1' }
package('ruby-dev') { version '4.8' }
package('rubygems') { version '1.7.2-1' }
gem_package('fpm') { version '0.3.11' }
gem_package('hpricot') { version '0.8.5' }
gem_package('json') { version '1.6.3' }
gem_package('kgio') { version '2.6.0' }
gem_package('mustache') { version '0.99.4' }
gem_package('rack') { version '1.3.5' }
gem_package('rack-protection') { version '1.1.4' }
gem_package('raindrops') { version '0.8.0' }
gem_package('rdiscount') { version '1.6.8' }
gem_package('sinatra') { version '1.3.1' }
gem_package('tilt') { version '1.3.3' }
gem_package('unicorn') { version '4.1.1' }
service('nginx') do
  action [:enable, :start]
  subscribes :restart, resources('cookbook_file[/etc/nginx/sites-available/example]', 'cookbook_file[/etc/nginx/sites-enabled/example]', 'package[nginx-common]', 'execute[82789250f3ad94d4cfeacc0a8cabae2d26b0270e.tar]')
end
service('example') do
  action [:enable, :start]
  provider Chef::Provider::Service::Upstart
  subscribes :restart, resources('cookbook_file[/etc/unicorn.conf.rb]', 'execute[82789250f3ad94d4cfeacc0a8cabae2d26b0270e.tar]')
end
</code></pre>

<hr><h1>
<a name="integrating-with-aws-cloudformation" class="anchor" href="#integrating-with-aws-cloudformation"><span class="octicon octicon-link"></span></a>Integrating with AWS CloudFormation</h1>

<p>Production environments are much more than a rack of servers these days and nowhere is that more apparent than AWS.  Blueprint integrates with AWS CloudFormation to provision and bootstrap entire infrastructures declaratively.</p>

<p>The <code>--cfn</code> option to <code>blueprint-show</code>(1) generates the skeleton of a CloudFormation template that provisions a single EC2 instance running Amazon Linux (an RPM-based distribution supported by Amazon) which will apply the blueprint during its first boot.</p>

<p>File templates and source tarballs aren't supported seamlessly, however.  File templates can be recreated using CloudFormation's primitive string functions or an executable user-data.  Source tarballs may reference fully-qualified URLs.</p>

<h2>
<a name="example-10" class="anchor" href="#example-10"><span class="octicon octicon-link"></span></a>Example</h2>

<p>Running <code>blueprint show --cfn example</code> creates <code>example.json</code>:</p>

<pre><code>{
  "AWSTemplateFormatVersion": "2010-09-09", 
  "Description": "Create an Amazon EC2 instance and bootstrap it as instructed by a blueprint.  This is intended to be a starting point for building larger architectures with AWS CloudFormation.  **WARNING** This template creates an Amazon EC2 instance.  You will be billed for the AWS resources used if you create a stack from this template.", 
  "Mappings": {
    "AWSInstanceType2Arch": {
      "c1.medium": {
        "Arch": "32"
      }, 
      "c1.xlarge": {
        "Arch": "64"
      }, 
      "cc1.4xlarge": {
        "Arch": "64"
      }, 
      "m1.large": {
        "Arch": "64"
      }, 
      "m1.small": {
        "Arch": "32"
      }, 
      "m1.xlarge": {
        "Arch": "64"
      }, 
      "m2.2xlarge": {
        "Arch": "64"
      }, 
      "m2.4xlarge": {
        "Arch": "64"
      }, 
      "m2.xlarge": {
        "Arch": "64"
      }, 
      "t1.micro": {
        "Arch": "32"
      }
    }, 
    "AWSRegionArch2AMI": {
      "ap-northeast-1": {
        "32": "ami-dcfa4edd", 
        "64": "ami-e8fa4ee9"
      }, 
      "ap-southeast-1": {
        "32": "ami-74dda626", 
        "64": "ami-7edda62c"
      }, 
      "eu-west-1": {
        "32": "ami-24506250", 
        "64": "ami-20506254"
      }, 
      "us-east-1": {
        "32": "ami-7f418316", 
        "64": "ami-7341831a"
      }, 
      "us-west-1": {
        "32": "ami-951945d0", 
        "64": "ami-971945d2"
      }
    }
  }, 
  "Outputs": {
    "PublicDnsName": {
      "Description": "Public DNS name of the EC2 instance.", 
      "Value": {
        "Fn::GetAtt": [
          "EC2Instance", 
          "PublicDnsName"
        ]
      }
    }
  }, 
  "Parameters": {
    "InstanceType": {
      "AllowedValues": [
        "t1.micro", 
        "m1.small", 
        "m1.large", 
        "m1.xlarge", 
        "m2.xlarge", 
        "m2.2xlarge", 
        "m2.4xlarge", 
        "c1.medium", 
        "c1.xlarge", 
        "cc1.4xlarge"
      ], 
      "ConstraintDescription": "must be a valid EC2 instance type.", 
      "Default": "m1.small", 
      "Description": "EC2 instance type.", 
      "Type": "String"
    }, 
    "KeyName": {
      "Description": "Name of an existing EC2 KeyPair to enable SSH access to the instances", 
      "Type": "String"
    }
  }, 
  "Resources": {
    "CfnUser": {
      "Properties": {
        "Path": "/", 
        "Policies": [
          {
            "PolicyDocument": {
              "Statement": [
                {
                  "Action": "cloudformation:DescribeStackResource", 
                  "Effect": "Allow", 
                  "Resource": "*"
                }
              ]
            }, 
            "PolicyName": "root"
          }
        ]
      }, 
      "Type": "AWS::IAM::User"
    }, 
    "EC2Instance": {
      "Metadata": {
        "AWS::CloudFormation::Init": {
          "config": {
            "files": {
              "/etc/init/example.conf": {
                "content": "description \"Example\"\nstart on runlevel [2345]\nstop on runlevel [!2345]\nrespawn\nchdir /usr/local/share/rack/example\nexec unicorn -c /etc/unicorn.conf.rb\n# Dear Blueprint, restart me when /etc/database.yml changes.\n", 
                "encoding": "plain", 
                "group": "root", 
                "mode": "100644", 
                "owner": "root"
              }, 
              "/etc/nginx/sites-available/example": {
                "content": "server {\n\tlisten 80 default;\n\tlocation /static { root /usr/local/share/rack/example/static; }\n\tlocation / { proxy_pass http://127.0.0.1:8080; }\n}\n", 
                "encoding": "plain", 
                "group": "root", 
                "mode": "100644", 
                "owner": "root"
              }, 
              "/etc/nginx/sites-enabled/example": {
                "content": "/etc/nginx/sites-available/example", 
                "encoding": "plain", 
                "group": "root", 
                "mode": "120777", 
                "owner": "root"
              }, 
              "/etc/unicorn.conf.rb": {
                "content": "worker_processes 4\n", 
                "encoding": "plain", 
                "group": "root", 
                "mode": "100644", 
                "owner": "root"
              }
            }, 
            "packages": {
              "apt": {
                "mysql-client-5.1": [
                  "5.1.58-1ubuntu1"
                ], 
                "nginx-common": [
                  "1.0.5-1"
                ], 
                "nginx-light": [
                  "1.0.5-1"
                ], 
                "ruby-dev": [
                  "4.8"
                ], 
                "rubygems": [
                  "1.7.2-1"
                ]
              }, 
              "rubygems": {
                "fpm": [
                  "0.3.11"
                ], 
                "hpricot": [
                  "0.8.5"
                ], 
                "json": [
                  "1.6.3"
                ], 
                "kgio": [
                  "2.6.0"
                ], 
                "mustache": [
                  "0.99.4"
                ], 
                "rack": [
                  "1.3.5"
                ], 
                "rack-protection": [
                  "1.1.4"
                ], 
                "raindrops": [
                  "0.8.0"
                ], 
                "rdiscount": [
                  "1.6.8"
                ], 
                "sinatra": [
                  "1.3.1"
                ], 
                "tilt": [
                  "1.3.3"
                ], 
                "unicorn": [
                  "4.1.1"
                ]
              }
            }, 
            "services": {
              "sysvinit": {
                "nginx": {
                  "enable": true, 
                  "ensureRunning": true, 
                  "files": [
                    "/etc/nginx/sites-enabled/example", 
                    "/etc/nginx/sites-available/example"
                  ], 
                  "packages": {
                    "apt": [
                      "nginx-common"
                    ]
                  }, 
                  "sources": [
                    "/usr/local"
                  ]
                }
              }, 
              "upstart": {
                "example": {
                  "enable": true, 
                  "ensureRunning": true, 
                  "files": [
                    "/etc/unicorn.conf.rb"
                  ], 
                  "sources": [
                    "/usr/local"
                  ]
                }
              }
            }, 
            "sources": {
              "/usr/local": "82789250f3ad94d4cfeacc0a8cabae2d26b0270e.tar"
            }
          }
        }
      }, 
      "Properties": {
        "ImageId": {
          "Fn::FindInMap": [
            "AWSRegionArch2AMI", 
            {
              "Ref": "AWS::Region"
            }, 
            {
              "Fn::FindInMap": [
                "AWSInstanceType2Arch", 
                {
                  "Ref": "InstanceType"
                }, 
                "Arch"
              ]
            }
          ]
        }, 
        "InstanceType": {
          "Ref": "InstanceType"
        }, 
        "KeyName": {
          "Ref": "KeyName"
        }, 
        "SecurityGroups": [
          {
            "Ref": "SecurityGroup"
          }
        ], 
        "UserData": {
          "Fn::Base64": {
            "Fn::Join": [
              "", 
              [
                "#!/bin/bash\n", 
                "/opt/aws/bin/cfn-init -s ", 
                {
                  "Ref": "AWS::StackName"
                }, 
                " -r EC2Instance ", 
                " --access-key ", 
                {
                  "Ref": "HostKeys"
                }, 
                " --secret-key ", 
                {
                  "Fn::GetAtt": [
                    "HostKeys", 
                    "SecretAccessKey"
                  ]
                }, 
                " --region ", 
                {
                  "Ref": "AWS::Region"
                }, 
                "\n", 
                "/opt/aws/bin/cfn-signal -e $? '", 
                {
                  "Ref": "WaitHandle"
                }, 
                "'\n"
              ]
            ]
          }
        }
      }, 
      "Type": "AWS::EC2::Instance"
    }, 
    "HostKeys": {
      "Properties": {
        "UserName": {
          "Ref": "CfnUser"
        }
      }, 
      "Type": "AWS::IAM::AccessKey"
    }, 
    "SecurityGroup": {
      "Properties": {
        "GroupDescription": "SSH access only.", 
        "SecurityGroupIngress": [
          {
            "CidrIp": "0.0.0.0/0", 
            "FromPort": "22", 
            "IpProtocol": "tcp", 
            "ToPort": "22"
          }
        ]
      }, 
      "Type": "AWS::EC2::SecurityGroup"
    }, 
    "WaitCondition": {
      "DependsOn": "EC2Instance", 
      "Properties": {
        "Handle": {
          "Ref": "WaitHandle"
        }, 
        "Timeout": "600"
      }, 
      "Type": "AWS::CloudFormation::WaitCondition"
    }, 
    "WaitHandle": {
      "Type": "AWS::CloudFormation::WaitConditionHandle"
    }
  }
}
</code></pre>

<hr><h1>
<a name="deploying-your-application-with-blueprint" class="anchor" href="#deploying-your-application-with-blueprint"><span class="octicon octicon-link"></span></a>Deploying your application with Blueprint</h1>

<p>The example running throughout this tutorial takes advantage of Blueprint's default handling of <code>/usr/local</code> to package up an example web application.  As an application grows, this can become muddled by other packages you install from source.</p>

<p>Blueprint doesn't dictate how you deploy your applications but here are a few options play very nicely with Blueprint.</p>

<ul>
<li>Build Debian packages or RPMs for your application.  These packages can include service init scripts or configuration files which Blueprint will take into account when restarting services after a deploy.</li>
<li>Use Blueprint to scaffold your application deployment and some other method (possibly via SSH tools like Capistrano or Fabric) to actually deploy.</li>
</ul><p>And remember to use templates to render configuration files appropriately in development, staging, and production.</p>

<hr><h1>
<a name="local-git-repository" class="anchor" href="#local-git-repository"><span class="octicon octicon-link"></span></a>Local Git repository</h1>

<p>Blueprints are stored in the local Git repository <code>~/.blueprints.git</code>.  Direct access isn't typically needed but Blueprint comes with the <code>blueprint-git</code>(1) tool that simplifies the parameters to <code>git</code>(1) needed to use this repository.</p>

<h2>
<a name="example-11" class="anchor" href="#example-11"><span class="octicon octicon-link"></span></a>Example</h2>

<p>Clone the entire local Git repository into <code>blueprints</code> in the working directory:</p>

<pre><code>blueprint git clone
</code></pre>

<p>Show the diff, from Git's point-of-view, between the previous two revisions of the <em>example</em> blueprint:</p>

<pre><code>blueprint git show example
</code></pre>

<p>The JSON document is pretty-printed for storage so Git's diffs will actually be meaningful.</p>

<hr><h1>
<a name="running-your-own-blueprint-server" class="anchor" href="#running-your-own-blueprint-server"><span class="octicon octicon-link"></span></a>Running your own Blueprint Server</h1>

<p><strong>DevStructure runs a free Blueprint Server at <code>devstructure.com</code> but this service will not be available after June 30<sup>th</sup>, 2012.</strong></p>

<p>Running a Blueprint Server opens up the <code>blueprint-push</code>(1) and <code>blueprint-pull</code>(1) commands so you can store your blueprints remotely and share them with your team.</p>

<p>The Blueprint Server <a href="#protocols">protocols</a> and <a href="#endpoints">endpoints</a> are documented for adventurous users that want to implement their own client or server.</p>

<h2>
<a name="installation-1" class="anchor" href="#installation-1"><span class="octicon octicon-link"></span></a>Installation</h2>

<p>Prerequisites:</p>

<ul>
<li><a href="http://code.google.com/p/boto/">Boto</a></li>
<li><a href="http://flask.pocoo.org">Flask</a></li>
<li><a href="http://gunicorn.org">GUnicorn</a></li>
</ul><p>Install the prerequisites from PyPI:</p>

<pre><code>sudo pip install boto flask gunicorn
</code></pre>

<p>The rest of Blueprint Server comes bundled with Blueprint itself in the <code>blueprint.io.server</code> module.</p>

<h2>
<a name="configuration" class="anchor" href="#configuration"><span class="octicon octicon-link"></span></a>Configuration</h2>

<p>Configure your Blueprint Server in <code>/etc/blueprint.cfg</code>:</p>

<pre><code>[s3]
access_key = <em>access_key</em>
secret_key = <em>secret_key</em>
bucket = <em>bucket</em></code></pre>

<p>Configure your other servers to communicate with the Blueprint Server in <code>/etc/blueprint.cfg</code>:</p>

<pre><code>[io]
server = <em>server</em></code></pre>

<p>Supervise Blueprint Server with Upstart on Ubuntu or CentOS 6:</p>

<pre><code>description "Blueprint Server"

start on runlevel [2345]
stop on runlevel [!2345]

respawn

env VIA=upstart

pre-start exec mkdir -p /var/log/blueprint-server

exec gunicorn -p/var/run/blueprint-server.pid -b0.0.0.0:5000 -w4 blueprint.io.server:app &gt;&gt;/var/log/blueprint-server/error.log 2&gt;&amp;1

# Mention /etc/blueprint.cfg so Blueprint will connect this service to that file.
</code></pre>

<p>Other platforms will have similar production configurations.</p>

<h2>
<a name="usage" class="anchor" href="#usage"><span class="octicon octicon-link"></span></a>Usage</h2>

<p>Start the server in development mode:</p>

<pre><code>python /usr/lib/python2.7/dist-packages/blueprint/io/server/__init__.py
</code></pre>

<p>(Note that the pathname may be different on your system, particularly if you installed Blueprint from source or from PyPI.)</p>

<p>Start the server in production mode running in the foreground:</p>

<pre><code>gunicorn blueprint.io.server:app
</code></pre>

<p>Some sort of process supervision, like Upstart as shown above, is recommended for production use.</p>

<h2>
<a name="example-12" class="anchor" href="#example-12"><span class="octicon octicon-link"></span></a>Example</h2>

<p>First, start your Blueprint Server:</p>

<pre><code>start blueprint-server
</code></pre>

<p>Push one of your blueprints to the Blueprint Server for safe-keeping or sharing with others:</p>

<pre><code>blueprint push example
</code></pre>

<p>Pull a blueprint from the Blueprint Server to configure new development environments or extra production capacity:</p>

<pre><code>blueprint pull example
</code></pre>

<hr><h1>
<a name="blueprint-server-protocols" class="anchor" href="#blueprint-server-protocols"><span class="octicon octicon-link"></span></a>Blueprint Server Protocols</h1>

<p>Prerequisite: obtain a secret key via the <code>GET /secret</code> endpoint.</p>

<h2>
<a name="storing-a-blueprint" class="anchor" href="#storing-a-blueprint"><span class="octicon octicon-link"></span></a>Storing a blueprint</h2>

<ol>
<li>Store the JSON representation of a blueprint via the <a href="#PUT-blueprint"><code>PUT /<em>secret</em>/<em>name</em></code></a> endpoint.</li>
<li>Store each tarball referenced in the <code>"sources"</code> object in the blueprint via the <a href="#PUT-tarball"><code>PUT /<em>secret</em>/<em>name</em>/<em>sha</em>.tar</code></a> endpoint.</li>
</ol><h2>
<a name="fetching-a-blueprint" class="anchor" href="#fetching-a-blueprint"><span class="octicon octicon-link"></span></a>Fetching a blueprint</h2>

<ol>
<li>Fetch the JSON representation of a blueprint via the <a href="#GET-blueprint"><code>GET /<em>secret</em>/<em>name</em></code></a> endpoint.</li>
<li>Fetch each tarball referenced in the <code>"sources"</code> object in the blueprint via the <a href="#GET-tarball"><code>GET /<em>secret</em>/<em>name</em>/<em>sha</em>.tar</code></a> endpoint.</li>
</ol><h2>
<a name="bootstrapping-on-aws" class="anchor" href="#bootstrapping-on-aws"><span class="octicon octicon-link"></span></a>Bootstrapping on AWS</h2>

<ol>
<li>Fetch the user data script for a blueprint via the <a href="#GET-user-data"><code>GET /<em>secret</em>/<em>name</em>/user-data.sh</code></a> endpoint.</li>
<li>Provision instances with the script as their user data via the AWS Management Console or an argument to the EC2 command-line tools.</li>
</ol><h2>
<a name="configuring-production-instances" class="anchor" href="#configuring-production-instances"><span class="octicon octicon-link"></span></a>Configuring production instances</h2>

<p>Production instances can use blueprints without installing Blueprint (and therefore Git and friends) by asking the Blueprint I/O Server to generate POSIX shell code.</p>

<ol>
<li>Fetch the POSIX shell representation of the blueprint via the <a href="#GET-sh"><code>GET /<em>secret</em>/<em>name</em>/<em>name</em>.sh</code></a> endpoint.  The resulting program will fetch tarballs as needed via the <a href="#GET-tarball"><code>GET /<em>secret</em>/<em>name</em>/<em>sha</em>.tar</code></a> endpoint.</li>
<li>
<code>sh <em>name</em>.sh</code> interactively, at boot, or periodically via <code>cron</code>(8).</li>
</ol><hr><h1>
<a name="blueprint-server-endpoints" class="anchor" href="#blueprint-server-endpoints"><span class="octicon octicon-link"></span></a>Blueprint Server Endpoints</h1>

<h2>
<a name="get-secret" class="anchor" href="#get-secret"><span class="octicon octicon-link"></span></a><code>GET /secret</code>
</h2>

<p>Create a new secret key known only to the caller.  This is the namespace beneath which the caller's blueprints are stored.</p>

<p>Responses:</p>

<ul>
<li>201: success; the body contains a new 64-byte secret key.</li>
<li>502: failure; the upstream storage service failed.</li>
</ul><h2>
<a name="put-secretname" class="anchor" href="#put-secretname"><span class="octicon octicon-link"></span></a><code>PUT /<em>secret</em>/<em>name</em></code>
</h2>

<p>Store the JSON representation of the blueprint <em>name</em>.  The <code>Content-Type</code> of the body must be <code>application/json</code>.</p>

<p>Parameters:</p>

<ul>
<li>
<em>secret</em>: a 64-byte identifier containing numbers, letters, underscores, and dashes.</li>
<li>
<em>name</em>: a blueprint name; it may not contain whitespace or <code>/</code> characters.</li>
</ul><p>Responses:</p>

<ul>
<li>202: success; the blueprint was well-formed and stored; the body contains pre-signed URIs for uploading source tarballs.</li>
<li>400: failure; the blueprint was not well-formed.</li>
<li>502: failure; the upstream storage service failed.</li>
</ul><h2>
<a name="get-secretname" class="anchor" href="#get-secretname"><span class="octicon octicon-link"></span></a><code>GET /<em>secret</em>/<em>name</em></code>
</h2>

<p>Fetch the JSON representation of the blueprint <em>name</em>.</p>

<p>Parameters:</p>

<ul>
<li>
<em>secret</em>: a 64-byte identifier containing numbers, letters, underscores, and dashes.</li>
<li>
<em>name</em>: a blueprint name; it may not contain whitespace or <code>/</code> characters.</li>
</ul><p>Responses:</p>

<ul>
<li>200: success; the body contains the JSON representation of the blueprint <em>name</em>.</li>
<li>404: failure; the <em>secret</em> or blueprint <em>name</em> was not found.</li>
<li>502: failure; the upstream storage service failed.</li>
</ul><h2>
<a name="put-secretnameshatar" class="anchor" href="#put-secretnameshatar"><span class="octicon octicon-link"></span></a><code>PUT /<em>secret</em>/<em>name</em>/<em>sha</em>.tar</code>
</h2>

<p>Store a source tarball referenced by blueprint <em>name</em>.  The <code>Content-Type</code> of the body must be <code>application/x-tar</code>.</p>

<p>Parameters:</p>

<ul>
<li>
<em>secret</em>: a 64-byte identifier containing numbers, letters, underscores, and dashes.</li>
<li>
<em>name</em>: a blueprint name; it may not contain whitespace or <code>/</code> characters.</li>
<li>
<em>sha</em>: a 40-byte hexadecimal representation of a SHA1 sum.</li>
</ul><p>Responses:</p>

<ul>
<li>202: success; the tarball was stored.</li>
<li>400: failure; the SHA1 sum of the body did not match <em>sha</em>.</li>
<li>404: failure; the <em>secret</em> or blueprint <em>name</em> was not found.</li>
<li>502: failure; the upstream storage service failed.</li>
</ul><h2>
<a name="get-secretnameshatar" class="anchor" href="#get-secretnameshatar"><span class="octicon octicon-link"></span></a><code>GET /<em>secret</em>/<em>name</em>/<em>sha</em>.tar</code>
</h2>

<p>Fetch a source tarball referenced by blueprint <em>name</em>.</p>

<p>Parameters:</p>

<ul>
<li>
<em>secret</em>: a 64-byte identifier containing numbers, letters, underscores, and dashes.</li>
<li>
<em>name</em>: a blueprint name; it may not contain whitespace or <code>/</code> characters.</li>
<li>
<em>sha</em>: a 40-byte hexadecimal representation of a SHA1 sum.</li>
</ul><p>Responses:</p>

<ul>
<li>200: success; the body contains the <code>application/x-tar</code> content of the source tarball.</li>
<li>404: failure; the <em>secret</em>, blueprint <em>name</em>, or <em>sha</em> was not found.</li>
<li>502: failure; the upstream storage service failed.</li>
</ul><h2>
<a name="get-secretnamenamesh" class="anchor" href="#get-secretnamenamesh"><span class="octicon octicon-link"></span></a><code>GET /<em>secret</em>/<em>name</em>/<em>name</em>.sh</code>
</h2>

<p>Fetch the POSIX shell representation of the blueprint <em>name</em>.  The resulting program will fetch tarballs as needed via the <code>GET /<em>secret</em>/<em>name</em>/<em>sha</em>.tar</code> endpoint.</p>

<p>Parameters:</p>

<ul>
<li>
<em>secret</em>: a 64-byte identifier containing numbers, letters, underscores, and dashes.</li>
<li>
<em>name</em>: a blueprint name; it may not contain whitespace or <code>/</code> characters.</li>
</ul><p>Responses:</p>

<ul>
<li>200: success; the body contains the POSIX shell representation of the blueprint <em>name</em>.</li>
<li>404: failure; the <em>secret</em> or blueprint <em>name</em> was not found.</li>
<li>502: failure; the upstream storage service failed.</li>
</ul><h2>
<a name="get-secretnameuser-datash" class="anchor" href="#get-secretnameuser-datash"><span class="octicon octicon-link"></span></a><code>GET /<em>secret</em>/<em>name</em>/user-data.sh</code>
</h2>

<p>Fetch POSIX shell commands to download and apply the blueprint <em>name</em>.  EC2 instances provisioned from an AMI with <a href="https://help.ubuntu.com/community/CloudInit"><code>cloud-init</code></a> will execute this program if given as user data.</p>

<p>Parameters:</p>

<ul>
<li>
<em>secret</em>: a 64-byte identifier containing numbers, letters, underscores, and dashes.</li>
<li>
<em>name</em>: a blueprint name; it may not contain whitespace or <code>/</code> characters.</li>
</ul><p>Responses:</p>

<ul>
<li>200: success; the body contains the POSIX shell representation of the blueprint <em>name</em>.</li>
<li>404: failure; the <em>secret</em> or blueprint <em>name</em> was not found.</li>
<li>502: failure; the upstream storage service failed.</li>
</ul><hr><h1>
<a name="contributing-to-blueprint" class="anchor" href="#contributing-to-blueprint"><span class="octicon octicon-link"></span></a>Contributing to Blueprint</h1>

<p>Blueprint is open-source, BSD-licensed software.  Contributions are welcome via pull requests on GitHub.</p>

<ul>
<li>Source code: <a href="https://github.com/devstructure/blueprint">https://github.com/devstructure/blueprint</a>
</li>
<li>Issue tracker: <a href="https://github.com/devstructure/blueprint/issues">https://github.com/devstructure/blueprint/issues</a>
</li>
<li>Mailing list: <a href="https://groups.google.com/forum/#!forum/blueprint-users">https://groups.google.com/forum/#!forum/blueprint-users</a>
</li>
<li>IRC: <a><code>irc.freenode.net#devstructure</code></a>
</li>
</ul><hr><h1>
<a name="alternatives-to-blueprint" class="anchor" href="#alternatives-to-blueprint"><span class="octicon octicon-link"></span></a>Alternatives to Blueprint</h1>

<p>If Blueprint's not your cup of tea, check out the following tools.  It's much better to have some form of configuration management than none at all.</p>

<ul>
<li><a href="http://docs.puppetlabs.com">Puppet</a></li>
<li><a href="http://wiki.opscode.com/display/chef/Home">Chef</a></li>
<li><a href="http://trac.mcs.anl.gov/projects/bcfg2/">Bcfg2</a></li>
<li><a href="http://cfengine.com/">CFEngine</a></li>
<li><a href="http://juju.ubuntu.com/">Juju</a></li>
</ul>
      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">Blueprint maintained by <a href="https://github.com/winstonford">winstonford</a></p>
        <p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

    

  </body>
</html>
